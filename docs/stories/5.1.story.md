# Story 5.1: Parse Existing CUE Files

## Story Details
- **Epic**: 5 - Build a Robust CUE File Handler
- **Story Number**: 5.1
- **Status**: Draft
- **Created**: 2025-08-27

## User Story
**As a** DJ with existing CUE files
**I want** the system to read and interpret my CUE files correctly
**So that** I can import my existing mix information

## Acceptance Criteria
1. Parse all standard CUE commands successfully
2. Handle multiple CUE format variants
3. Extract complete track listing with timestamps
4. Preserve all metadata and custom fields
5. Report parsing errors with helpful messages

## Tasks / Subtasks

### Task 1: Create CUE Parser Module Structure (AC: 1)
- [ ] Create services/analysis_service/src/cue_handler/__init__.py
- [ ] Create services/analysis_service/src/cue_handler/parser.py
- [ ] Create services/analysis_service/src/cue_handler/models.py
- [ ] Create services/analysis_service/src/cue_handler/exceptions.py

### Task 2: Implement CUE Data Models (AC: 1, 3, 4)
- [ ] Create CueSheet model class with file references, tracks, and metadata
- [ ] Create Track model class with all track-level attributes
- [ ] Create CueTime class for frame-accurate timestamp handling (MM:SS:FF format)
- [ ] Add validation methods for model constraints

### Task 3: Implement Core CUE Parser (AC: 1, 2)
- [ ] Implement command tokenizer for CUE file lines
- [ ] Parse FILE command with format detection (WAVE, MP3, BINARY, etc.)
- [ ] Parse TRACK command with data type support (AUDIO, CDG, MODE1/2048, etc.)
- [ ] Parse INDEX commands (00 for pregap, 01 for track start, 02-99 for subdivisions)
- [ ] Parse metadata commands (TITLE, PERFORMER, SONGWRITER)
- [ ] Parse disc-level commands (CATALOG, CDTEXTFILE)
- [ ] Parse track-level commands (FLAGS, ISRC, PREGAP, POSTGAP)

### Task 4: Implement Extended REM Command Parser (AC: 2, 4)
- [ ] Parse REM GENRE, DATE, DISCID, COMMENT
- [ ] Parse REM DISCNUMBER for multi-disc sets
- [ ] Parse REM COMPOSER
- [ ] Parse REM REPLAYGAIN_* fields (ALBUM_GAIN, ALBUM_PEAK, TRACK_GAIN, TRACK_PEAK)
- [ ] Support alternative comment syntax (";" and "//" prefixes)
- [ ] Handle custom/proprietary REM fields with flexible storage

### Task 5: Implement Encoding Detection and Handling (AC: 2, 5)
- [ ] Auto-detect encoding (UTF-8, Latin-1, Windows-1252, extended ASCII)
- [ ] Handle quoted strings and special characters
- [ ] Support whitespace flexibility (spaces and tabs)
- [ ] Implement graceful error recovery for encoding issues

### Task 6: Implement Multi-File CUE Support (AC: 1, 2)
- [ ] Parse multiple FILE entries in single CUE sheet
- [ ] Track file references per track
- [ ] Validate file transitions between tracks
- [ ] Handle relative and absolute file paths

### Task 7: Implement Command Order Validation (AC: 1, 5)
- [ ] Validate CATALOG appears before FILE
- [ ] Validate FILE appears before TRACK
- [ ] Validate INDEX ordering (00 before 01, sequential numbering)
- [ ] Report command ordering violations with line numbers

### Task 8: Implement Error Handling and Reporting (AC: 5)
- [ ] Create detailed parsing error messages with line numbers
- [ ] Implement warning system for non-critical issues
- [ ] Track parsing state for better error context
- [ ] Generate parsing report with errors and warnings

### Task 9: Create Unit Tests for Parser
- [ ] Test parsing of all standard CUE commands
- [ ] Test multi-file CUE sheets
- [ ] Test various encodings (UTF-8, Latin-1, etc.)
- [ ] Test error handling and reporting
- [ ] Test edge cases and malformed files
- [ ] Test alternative comment syntax
- [ ] Test frame time calculations (75 fps)

## Dev Notes

### Relevant Architecture Information

#### Tech Stack
[Source: architecture/tech-stack.md]
- **Language**: Python 3.13
- **Database**: PostgreSQL 17 with SQLAlchemy ORM
- **Migrations**: Alembic for schema management
- **Testing**: pytest framework
- **Code Standards**: ruff for linting, mypy for type checking

#### Project Structure
[Source: architecture/source-tree.md]
The CUE handler will be part of the analysis_service:
- Location: `services/analysis_service/src/cue_handler/`
- Tests: `tests/unit/analysis_service/test_cue_handler/`

#### Data Models
[Source: architecture/data-models-refined-and-finalized.md#tracklist]
The Tracklist model already exists with:
- `cue_file_path`: String field for storing generated CUE file path
- `tracks`: JSONB array containing track information (title, artist, start_time)
- This story focuses on parsing CUE files to populate these existing structures

[Source: shared/core_types/src/models.py#L104-139]
Existing Tracklist SQLAlchemy model:
- Uses PostgreSQL JSONB for tracks storage
- Has `validate_tracks()` method checking for required keys (title, artist, start_time)
- Related to Recording model via foreign key

#### CUE Specification Details from Epic
[Source: docs/prd/epic-5-cue-file-handler.md#L74-153]

**Time Format (Wikipedia Specification)**:
- Format: MM:SS:FF (minute:second:frame)
- Frame Rate: 75 frames per second
- 1 second = 75 frames
- All times cumulative from start of file

**Essential Commands**:
- FILE: filename and format (WAVE, MP3, BINARY, MOTOROLA, AIFF)
- TRACK: number (01-99) and type (AUDIO, CDG, MODE1/2048, etc.)
- INDEX: track position (01 required, 00 for pregap)

**Metadata Commands**:
- REM: Comments and extensions
- TITLE: Max 80 chars for CD-Text
- PERFORMER: Max 80 chars
- SONGWRITER: Track songwriter
- CDTEXTFILE: External CD-Text reference

**Extended REM Commands**:
- REM GENRE, DATE, DISCID, COMMENT
- REM DISCNUMBER (1-15 for Kodi)
- REM COMPOSER
- REM REPLAYGAIN_* fields

**Key Discrepancies to Handle**:
1. Frame range: 75 frames/second (some specs show 0-74 range)
2. FLAC files commonly use WAVE type
3. Alternative comment syntax: REM, ";", "//"
4. Command repetition allowed
5. Extended ASCII support beyond UTF-8

### Testing Standards
[Source: architecture/test-strategy-and-standards.md]
- **Framework**: pytest with `uv run pytest` execution
- **Test Files**: Named `test_*.py` in `tests/unit/analysis_service/test_cue_handler/`
- **Coverage Goal**: Minimum 80% for new code
- **Required**: All unit tests must pass before task completion
- **Execution**: Run tests after each task with `uv run pytest tests/unit/analysis_service/test_cue_handler/ -v`

### Code Standards
[Source: architecture/coding-standards.md]
- **MANDATORY**: Use `uv run python` instead of `python` or `python3`
- **MANDATORY**: Use `uv run pytest` for running tests
- **Pre-commit hooks**: Must pass before committing (ruff, mypy, etc.)
- **Line length**: Maximum 120 characters
- **Type hints**: Required with mypy validation

### Previous Story Context
No previous stories in Epic 5. This is the first implementation of CUE file handling.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-27 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent after implementation*
