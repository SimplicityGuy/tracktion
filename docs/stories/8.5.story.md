# Story 8.5: Async External Service Calls

## Status
Approved

## Story
**As a** system calling external APIs,
**I want** non-blocking HTTP requests,
**so that** external service delays don't block operations

## Acceptance Criteria
1. All HTTP calls use async clients
2. Concurrent request handling
3. Retry logic is async-aware
4. Circuit breakers implemented
5. Connection pooling configured

## Tasks / Subtasks
- [ ] Task 1: Set up async HTTP clients (AC: 1, 5)
  - [ ] Install httpx for async HTTP support
  - [ ] Configure aiohttp as alternative client
  - [ ] Set up connection pool configuration
  - [ ] Create client factory with proper settings

- [ ] Task 2: Refactor tracklist_service external calls (AC: 1, 2)
  - [ ] Convert 1001tracklists.com API calls to async
  - [ ] Implement concurrent request batching
  - [ ] Add request queuing for rate limiting
  - [ ] Update response parsing for async

- [ ] Task 3: Implement retry mechanism (AC: 3)
  - [ ] Create async retry decorator
  - [ ] Implement exponential backoff
  - [ ] Add jitter to prevent thundering herd
  - [ ] Configure max retry attempts per service

- [ ] Task 4: Add circuit breaker pattern (AC: 4)
  - [ ] Install py-breaker or implement custom
  - [ ] Configure circuit breaker thresholds
  - [ ] Implement half-open state testing
  - [ ] Add fallback mechanisms

- [ ] Task 5: Connection pool optimization (AC: 5)
  - [ ] Configure pool size limits (20-50 connections)
  - [ ] Implement connection keep-alive
  - [ ] Add connection health checks
  - [ ] Monitor pool utilization metrics

- [ ] Task 6: Timeout and cancellation handling (AC: 1, 4)
  - [ ] Set request timeouts per service
  - [ ] Implement request cancellation
  - [ ] Add timeout escalation strategy
  - [ ] Create deadline propagation

- [ ] Task 7: Error handling and monitoring (AC: 3, 4)
  - [ ] Log all external service calls
  - [ ] Track success/failure rates
  - [ ] Implement alerting for circuit breaks
  - [ ] Add correlation ID propagation

- [ ] Task 8: Testing and performance validation (AC: All)
  - [ ] Create mock external services for testing
  - [ ] Test retry logic with failures
  - [ ] Validate circuit breaker behavior
  - [ ] Load test concurrent requests
  - [ ] Ensure 80% code coverage

## Dev Notes

### Relevant Architecture Context

#### Service Communication
[Source: architecture/coding-standards.md#critical-rules]
- Services communicate via RabbitMQ internally
- External API calls are for third-party services only
- No direct HTTP calls between internal services

#### External Services
[Source: Epic context and PRD]
- 1001tracklists.com API (tracklist data)
- Future: Additional music metadata APIs
- Future: Streaming service APIs

#### Tech Stack
[Source: architecture/tech-stack.md]
- Python 3.13 with async/await
- RabbitMQ 4.0 for internal messaging
- Redis 7.4 for caching external responses
- Docker for service containerization

#### Project Structure
[Source: architecture/source-tree.md]
External service calls primarily in:
- `services/tracklist_service/src/` - Main implementation
- `shared/utils/` - Shared HTTP client utilities
- `tests/unit/tracklist_service/` - Unit tests

#### Async Libraries for HTTP
[Source: Epic 7 PRD]
- **httpx**: Modern async HTTP client
- **aiohttp**: Alternative async HTTP library
- Connection pooling: 20-50 connections
- Retry with exponential backoff
- Circuit breaker pattern required

#### Performance Requirements
[Source: Epic 7 PRD]
- Support >100 concurrent external requests
- Response timeout: 10s default
- Connection pool: 20-50 connections
- Circuit breaker threshold: 50% failure rate
- Retry attempts: 3 with exponential backoff

### Critical Implementation Details

#### HTTP Client Configuration
```python
import httpx
from typing import Optional

async def create_client() -> httpx.AsyncClient:
    return httpx.AsyncClient(
        timeout=httpx.Timeout(10.0),
        limits=httpx.Limits(
            max_keepalive_connections=20,
            max_connections=50,
        ),
        headers={"User-Agent": "tracktion/1.0"}
    )
```

#### Retry Strategy
- Initial delay: 1 second
- Max delay: 30 seconds
- Exponential factor: 2
- Jitter: 0-1 second random
- Max attempts: 3

#### Circuit Breaker Configuration
- Failure threshold: 50% (5 failures in 10 requests)
- Recovery timeout: 60 seconds
- Half-open test requests: 1
- Success threshold to close: 2 consecutive

#### Connection Pool Strategy
- Min connections: 10
- Max connections: 50
- Keep-alive timeout: 30s
- Connection TTL: 5 minutes
- Health check interval: 60s

### Error Handling Patterns
[Source: architecture/error-handling-strategy.md]
- Retry transient errors (network, timeout)
- Circuit break on persistent failures
- Cache successful responses in Redis
- Log all external calls with correlation ID
- Fallback to cached data when available

### Testing Requirements
[Source: architecture/test-strategy-and-standards.md]
- Test location: `tests/unit/tracklist_service/`
- Use `uv run pytest` for execution
- Mock external services with httpx-mock
- Test retry scenarios
- Test circuit breaker states
- Minimum 80% code coverage

### Coding Standards
[Source: architecture/coding-standards.md]
- Use `uv run` for all Python execution
- Async functions with proper type hints
- Environment variables for API keys
- No hardcoded URLs or credentials
- Maximum line length: 120 characters

### Security Considerations
- API keys in environment variables
- Request signing where required
- Rate limiting compliance
- User-Agent headers required
- SSL/TLS verification enabled

### Caching Strategy
- Cache successful responses in Redis
- TTL based on data volatility
- Cache key includes request parameters
- Invalidation on data updates
- Fallback to cache on failures

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-28 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)
