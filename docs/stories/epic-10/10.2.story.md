# Story 10.2: Unified Discord Notification Architecture

## Status
Approved

## Story
**As a** system requiring notifications
**I want** a unified Discord notification architecture
**So that** we have reliable, maintainable, and extensible Discord alerting

## Acceptance Criteria
1. Discord webhook implementation
2. Channel-specific webhook routing
3. Abstract notification interface
4. Retry logic for failed notifications
5. Notification history logging
6. Template system for consistent messaging
7. Rate limiting compliance
8. Error handling for failed sends
9. Configuration via environment variables
10. Documentation for setup

## Tasks / Subtasks
- [ ] Design abstract notification interface (AC: 3)
  - [ ] Create NotificationChannel abstract base class
  - [ ] Define standard message format and metadata
  - [ ] Create notification result and status types
  - [ ] Design Discord-specific implementation
- [ ] Implement Discord webhook integration (AC: 1, 8)
  - [ ] Create Discord webhook client
  - [ ] Add webhook URL configuration per channel type
  - [ ] Implement message sending with proper error handling
  - [ ] Add connection timeout and retry logic
- [ ] Build channel-specific routing system (AC: 2)
  - [ ] Create channel mapping for alert types
  - [ ] Support different webhooks for different alert severities
  - [ ] Implement webhook URL environment variables:
    - [ ] DISCORD_WEBHOOK_GENERAL
    - [ ] DISCORD_WEBHOOK_ERRORS
    - [ ] DISCORD_WEBHOOK_CRITICAL
    - [ ] DISCORD_WEBHOOK_TRACKLIST
    - [ ] DISCORD_WEBHOOK_MONITORING
    - [ ] DISCORD_WEBHOOK_SECURITY
- [ ] Implement unified retry system (AC: 4)
  - [ ] Create retry policy configuration
  - [ ] Implement exponential backoff strategy
  - [ ] Add dead letter queue for permanent failures
  - [ ] Create retry status tracking and metrics
- [ ] Add notification history logging (AC: 5)
  - [ ] Create notification history data model
  - [ ] Implement notification event logging
  - [ ] Add history query and reporting API
  - [ ] Create history cleanup and archiving
- [ ] Build Discord template system (AC: 6)
  - [ ] Create Discord embed templates
  - [ ] Implement template rendering for different alert types
  - [ ] Add template validation and testing
  - [ ] Support rich formatting with colors and fields
- [ ] Implement rate limiting compliance (AC: 7)
  - [ ] Add rate limiting for webhook calls (30/min per webhook)
  - [ ] Implement request queuing and throttling
  - [ ] Monitor rate limit headers and back off
  - [ ] Add per-channel rate limit tracking
- [ ] Add comprehensive error handling (AC: 8)
  - [ ] Handle webhook failures and retries
  - [ ] Implement circuit breaker for failed channels
  - [ ] Add delivery status tracking
  - [ ] Create fallback mechanisms
- [ ] Implement environment configuration (AC: 9)
  - [ ] Create unified Discord configuration
  - [ ] Add environment variable parsing and validation
  - [ ] Support optional configuration (rate limits, timeouts)
  - [ ] Add configuration documentation
- [ ] Create setup documentation (AC: 10)
  - [ ] Document Discord webhook setup process
  - [ ] Provide channel configuration guide
  - [ ] Add troubleshooting guide
  - [ ] Create migration guide from old system
- [ ] Remove legacy notification code
  - [ ] Remove all Slack implementation and references
  - [ ] Remove all email/SMTP implementation and references
  - [ ] Clean up old AlertChannel enum values
  - [ ] Update all existing notification calls
- [ ] Write comprehensive tests
  - [ ] Test Discord webhook integration
  - [ ] Test channel-specific routing
  - [ ] Test rate limiting and backoff logic
  - [ ] Test message formatting and template rendering
  - [ ] Test error handling and retry mechanisms
  - [ ] Test configuration loading and validation

## Dev Notes

### Unified Architecture Design
This story combines Discord integration with a clean notification architecture, creating a single, well-designed notification system focused exclusively on Discord.

### Discord Channel Architecture
```python
from enum import Enum
from typing import Optional
import os

class AlertType(Enum):
    """Types of alerts with dedicated Discord channels."""
    GENERAL = "general"
    ERROR = "error"
    CRITICAL = "critical"
    TRACKLIST = "tracklist"
    MONITORING = "monitoring"
    SECURITY = "security"

class DiscordNotificationService:
    """Unified Discord notification service."""

    def __init__(self):
        self.webhooks = {
            AlertType.GENERAL: os.getenv("DISCORD_WEBHOOK_GENERAL"),
            AlertType.ERROR: os.getenv("DISCORD_WEBHOOK_ERRORS"),
            AlertType.CRITICAL: os.getenv("DISCORD_WEBHOOK_CRITICAL"),
            AlertType.TRACKLIST: os.getenv("DISCORD_WEBHOOK_TRACKLIST"),
            AlertType.MONITORING: os.getenv("DISCORD_WEBHOOK_MONITORING"),
            AlertType.SECURITY: os.getenv("DISCORD_WEBHOOK_SECURITY"),
        }
        self.rate_limiter = RateLimiter(limit=30, window=60)  # 30/min per webhook
        self.retry_manager = RetryManager(max_attempts=3, backoff_base=2)
        self.history_logger = NotificationHistoryLogger()

    async def send_notification(
        self,
        alert_type: AlertType,
        title: str,
        message: str,
        color: Optional[int] = None,
        fields: Optional[List[Dict]] = None
    ) -> NotificationResult:
        """Send notification to appropriate Discord channel."""
        webhook_url = self.webhooks.get(alert_type)
        if not webhook_url:
            return NotificationResult(success=False, error="No webhook configured")

        # Check rate limits
        if not await self.rate_limiter.allow(webhook_url):
            return await self.queue_notification(alert_type, title, message)

        # Build Discord embed
        embed = self.build_embed(alert_type, title, message, color, fields)

        # Send with retry logic
        result = await self.retry_manager.execute(
            self._send_to_discord,
            webhook_url,
            embed
        )

        # Log to history
        await self.history_logger.log(alert_type, title, result)

        return result
```

### Discord Embed Templates
```python
class DiscordEmbedBuilder:
    """Builder for Discord embed messages."""

    COLOR_MAP = {
        AlertType.GENERAL: 0x3498db,    # Blue
        AlertType.ERROR: 0xe67e22,      # Orange
        AlertType.CRITICAL: 0xe74c3c,   # Red
        AlertType.TRACKLIST: 0x2ecc71,  # Green
        AlertType.MONITORING: 0x9b59b6, # Purple
        AlertType.SECURITY: 0xf39c12,   # Yellow
    }

    def build_embed(
        self,
        alert_type: AlertType,
        title: str,
        description: str,
        fields: Optional[List[Dict]] = None
    ) -> dict:
        """Build Discord embed message."""
        embed = {
            "title": title,
            "description": description,
            "color": self.COLOR_MAP.get(alert_type, 0x95a5a6),
            "timestamp": datetime.utcnow().isoformat(),
            "footer": {
                "text": f"Tracktion {alert_type.value.title()} Alert"
            }
        }

        if fields:
            embed["fields"] = fields

        return {"embeds": [embed]}
```

### Environment Configuration
```bash
# Discord Webhook Configuration (required)
DISCORD_WEBHOOK_GENERAL=https://discord.com/api/webhooks/...
DISCORD_WEBHOOK_ERRORS=https://discord.com/api/webhooks/...
DISCORD_WEBHOOK_CRITICAL=https://discord.com/api/webhooks/...
DISCORD_WEBHOOK_TRACKLIST=https://discord.com/api/webhooks/...
DISCORD_WEBHOOK_MONITORING=https://discord.com/api/webhooks/...
DISCORD_WEBHOOK_SECURITY=https://discord.com/api/webhooks/...

# Optional Discord Configuration
DISCORD_RATE_LIMIT=30           # Max messages per minute per webhook (default: 30)
DISCORD_RETRY_ATTEMPTS=3         # Number of retry attempts (default: 3)
DISCORD_TIMEOUT_SECONDS=10       # Request timeout (default: 10)
DISCORD_QUEUE_SIZE=100          # Max queued messages per channel (default: 100)
```

### Migration from Legacy System
The current AlertManager has Slack and Email channels that need to be removed:
1. Replace AlertChannel enum with AlertType
2. Remove `_send_to_slack()` and `_send_to_email()` methods
3. Update all notification calls to use new DiscordNotificationService
4. Update all tests to verify Discord-only behavior

### File Locations
- Service: `services/notification_service/` (new) or update `services/tracklist_service/src/monitoring/`
- Tests: `tests/unit/notification_service/` or `tests/unit/tracklist_service/test_notifications.py`
- Config: `.env.example` with Discord webhook examples
- Docs: `docs/discord-notification-setup.md`

### Technical Constraints
[Source: architecture/coding-standards.md, architecture/tech-stack.md]

- Use `uv run` for all Python commands
- Async/await for all I/O operations
- Environment variables for all configuration
- Structured logging throughout
- All pre-commit hooks must pass
- Maintain backward compatibility during migration

### Performance Requirements
- Notification sending: <500ms per message
- Rate limiting: Respect Discord's 30 requests/minute per webhook
- Queue processing: Handle burst of 100+ notifications
- History queries: <100ms for recent notifications
- Retry delays: Exponential backoff starting at 1s

## Testing
[Source: architecture/test-strategy-and-standards.md]

### Testing Requirements
- Test location: `tests/unit/tracklist_service/` or new `tests/unit/notification_service/`
- Use pytest as testing framework
- Execute with `uv run pytest tests/ -v`
- Minimum 80% code coverage

### Testing Categories
1. **Unit Tests**: Discord client, rate limiter, retry logic
2. **Integration Tests**: End-to-end notification flow
3. **Configuration Tests**: Environment variable loading and validation
4. **Error Tests**: Network failures, invalid webhooks, rate limiting
5. **Template Tests**: Embed building and formatting
6. **Performance Tests**: Rate limiting, queue processing

### Mock Requirements
- Mock Discord webhook responses
- Mock network failures and timeouts
- Mock rate limit headers
- Test with various alert types and severities

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-01 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-09-01 | 2.0 | Combined Stories 10.2 and 10.3 into unified Discord architecture | Development Team |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here after implementation*
