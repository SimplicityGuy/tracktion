# Story 12.3: VA and Compilation Support

## Status
Draft

## Story
**As a** DJ/compiler,
**I want** Various Artists releases handled correctly,
**so that** compilations are properly organized

## Acceptance Criteria
1. Detect VA compilations automatically
2. Use "VA" as artist in dirname
3. Include track artists in filenames
4. Handle mixed artist albums
5. Support DJ mixes and compilations
6. Maintain proper track ordering

## Tasks / Subtasks

- [ ] **Task 1: VA Detection Engine (AC: 1)**
  - [ ] Create `VADetector` class in `mp3_naming` module
  - [ ] Analyze track metadata for multiple different artists
  - [ ] Implement artist variation threshold for VA determination
  - [ ] Detect common VA compilation indicators in metadata
  - [ ] Handle edge cases like guest features vs true VA releases
  - [ ] Create unit tests for VA detection logic

- [ ] **Task 2: Dirname VA Handler (AC: 2)**
  - [ ] Implement `VADirnameFormatter` class
  - [ ] Replace main artist with "VA" in dirname structure
  - [ ] Preserve compilation title and other dirname elements
  - [ ] Handle VA with featured main artist scenarios
  - [ ] Ensure compliance with MP3 Rules 4.1 for VA releases
  - [ ] Create dirname formatting tests for VA releases

- [ ] **Task 3: Track Artist Filename Integration (AC: 3)**
  - [ ] Create `TrackArtistFilenameFormatter` class
  - [ ] Include individual track artists in filename structure
  - [ ] Format: Track Number - Track Artist - Song Title
  - [ ] Handle long artist names with intelligent truncation
  - [ ] Preserve essential artist information in limited space
  - [ ] Create filename formatting tests for track artists

- [ ] **Task 4: Mixed Artist Album Handler (AC: 4)**
  - [ ] Implement `MixedArtistProcessor` class
  - [ ] Distinguish between true VA and single artist with guests
  - [ ] Handle albums with primary artist + various guest features
  - [ ] Set thresholds for when to classify as VA vs main artist
  - [ ] Process collaborative albums appropriately
  - [ ] Create mixed artist classification tests

- [ ] **Task 5: DJ Mix and Compilation Support (AC: 5)**
  - [ ] Create `DJMixProcessor` class
  - [ ] Detect DJ mix compilation patterns
  - [ ] Handle continuous mix vs individual track compilations
  - [ ] Support various compilation types (label comps, genre comps, etc.)
  - [ ] Manage compilation-specific metadata and tagging
  - [ ] Create DJ mix and compilation handling tests

- [ ] **Task 6: Track Ordering Preservation (AC: 6)**
  - [ ] Implement `TrackOrderingManager` class
  - [ ] Maintain proper track numbering in VA releases
  - [ ] Handle disc-based ordering for multi-disc VA releases
  - [ ] Preserve original track sequence from tracklist data
  - [ ] Support manual track reordering when needed
  - [ ] Create track ordering validation tests

## Dev Notes

### Previous Story Insights
Builds on Stories 12.1 and 12.2:
- Uses core naming convention structure from Story 12.1
- Integrates with source type detection from Story 12.2 for proper VA compilation tagging
- Leverages character sanitization for track artist names

### Data Models
This story extensively uses tracklist data:
- **Recording Model**: Access to `file_path` and `file_name` for context [Source: architecture/data-models-refined-and-finalized.md#recording]
- **Metadata Model**: Extended use for compilation detection metadata [Source: architecture/data-models-refined-and-finalized.md#metadata]
- **Tracklist Model**: Primary data source for track artists and ordering with `tracks` JSONB array containing title, artist, and start time [Source: architecture/data-models-refined-and-finalized.md#tracklist]

### File Locations
Extending the mp3_naming module:
- **VA Processing**: `services/file_rename_service/src/mp3_naming/va_processing/` [Source: architecture/source-tree.md]
- **Unit Tests**: `tests/unit/file_rename_service/mp3_naming/va_processing/` [Source: architecture/test-strategy-and-standards.md#unit-tests]

### Technical Constraints
Same as previous stories:
- **Python Version**: Python 3.13 [Source: architecture/tech-stack.md]
- **Package Management**: All commands must use `uv run` [Source: architecture/coding-standards.md#python-execution-standards]
- **ORM**: SQLAlchemy for database access to tracklist data [Source: architecture/tech-stack.md]
- **Line Length**: Maximum 120 characters [Source: architecture/coding-standards.md]

### Integration Points
Extends previous story integration points:
- **Tracklist Service**: Primary data source for track artist information and ordering [Source: architecture/service-interactions.md#tracklist-service-integration]
- **Analysis Service**: Uses analysis results for VA detection patterns [Source: architecture/service-interactions.md#analysis-service-integration]
- **File Rename Service**: Enhanced rename proposals for VA releases [Source: architecture/service-interactions.md#file-rename-service-integration]

### MP3 Rules 4.1 VA Requirements
Based on Epic 12 specification:
- **VA Dirname**: Use "VA" as artist in dirname structure for Various Artists
- **Track Artists**: Include individual track artists in filename structure
- **Compilation Title**: Preserve compilation title in dirname
- **Character Limits**: Respect 255 character total limit for dirname+filename
- **Track Ordering**: Maintain proper sequential track numbering

### Tracklist Data Integration
Key integration with tracklist data structure:
- **Track Array**: JSONB array with title, artist, start time for each track
- **Track Artists**: Extract individual artist names from track data
- **Track Ordering**: Use array index and start time for proper sequencing
- **CUE File Path**: Reference to generated CUE file for additional track information

### Testing Standards
Same as previous stories:
- **Framework**: pytest with `uv run pytest` execution [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **File Convention**: `test_*.py` files in `tests/unit/` directory [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Coverage**: Minimum 80% coverage for new code [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- **Test Location**: `tests/unit/file_rename_service/mp3_naming/va_processing/`

### Pre-Commit Requirements
Same requirements as previous stories:
- All pre-commit hooks MUST pass: ruff linting, ruff formatting, mypy type checking [Source: architecture/coding-standards.md#pre-commit-workflow]
- Execute via: `uv run pre-commit run --all-files` [Source: architecture/coding-standards.md#pre-commit-workflow]

## Testing

### Testing Standards
- **Test Framework**: pytest executed via `uv run pytest` [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Test Location**: All tests in `tests/unit/file_rename_service/mp3_naming/va_processing/` directory [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Naming Convention**: Test files named `test_*.py` [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Coverage Requirement**: Minimum 80% code coverage for all new code [Source: architecture/test-strategy-and-standards.md#testing-philosophy]

### Testing Requirements for This Story
- VA detection accuracy testing with various compilation types
- Dirname formatting tests for VA releases with different compilation titles
- Track artist filename formatting with character limit compliance
- Mixed artist album classification testing (VA vs main artist + guests)
- DJ mix and compilation type detection and processing tests
- Track ordering preservation testing with multi-disc and complex releases

### Test Execution Commands
- Run story-specific tests: `uv run pytest tests/unit/file_rename_service/mp3_naming/va_processing/ -v`
- Run all unit tests: `uv run pytest tests/unit/ -v`
- Run with coverage: `uv run pytest tests/unit/file_rename_service/mp3_naming/va_processing/ --cov=services.file_rename_service.src.mp3_naming.va_processing --cov-report=term-missing`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-09-04 | 1.0 | Initial story creation for VA and compilation support | Scrum Master |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by development agent*

### Debug Log References
*To be filled by development agent*

### Completion Notes List
*To be filled by development agent*

### File List
*To be filled by development agent*

## QA Results

*This section will be populated by the QA Agent after story completion*
