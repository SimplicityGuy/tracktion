# Story 12.1: Core Naming Convention Engine

## Status
Draft

## Story
**As a** music organizer,
**I want** files named according to MP3 scene standards,
**so that** my library follows professional conventions

## Acceptance Criteria
1. Implement dirname structure parser and generator
2. Support all required tags and formats
3. Handle character restrictions properly
4. Validate against MP3 Rules 4.1
5. Generate compliant names from metadata
6. Handle edge cases and exceptions

## Tasks / Subtasks

- [ ] **Task 1: Create MP3 Naming Convention Core Module (AC: 1, 2)**
  - [ ] Create `services/file_rename_service/src/mp3_naming/` module structure
  - [ ] Implement `NamingConventionEngine` class with dirname structure parser
  - [ ] Implement tag parsing (Artist - Title - Year - Group format)
  - [ ] Add support for all required source tags (CD, WEB, VINYL, FM, etc.)
  - [ ] Create unit tests for core parsing functionality

- [ ] **Task 2: Character Restriction Handler (AC: 3)**
  - [ ] Implement `CharacterSanitizer` class
  - [ ] Handle allowed characters: a-z A-Z 0-9 _ . - ()
  - [ ] Replace invalid characters appropriately
  - [ ] Handle foreign character conversion
  - [ ] Test filesystem compatibility across platforms
  - [ ] Create unit tests for character sanitization

- [ ] **Task 3: MP3 Rules 4.1 Validator (AC: 4)**
  - [ ] Create `MP3RulesValidator` class
  - [ ] Validate dirname format: Artist - Title - Year - Group
  - [ ] Validate filename format: Track Number - Artist - Title
  - [ ] Check maximum dirname+filename: 255 characters
  - [ ] Validate special source tags and multi-disc notation
  - [ ] Create comprehensive test cases against MP3 Rules 4.1

- [ ] **Task 4: Metadata to Name Generator (AC: 5)**
  - [ ] Implement `MetadataToNameMapper` class
  - [ ] Extract artist, title, year from Recording metadata
  - [ ] Generate dirname from metadata following MP3 conventions
  - [ ] Generate filename from track metadata
  - [ ] Handle missing metadata fields gracefully
  - [ ] Create unit tests for metadata mapping

- [ ] **Task 5: Edge Case Handler (AC: 6)**
  - [ ] Handle special release types (BOOTLEG, MAG, OST, SINGLE)
  - [ ] Manage multi-disc notation (-2CD-, -3DVD-, etc.)
  - [ ] Process compilation and VA releases appropriately
  - [ ] Handle live source formatting (FM, SAT, SBD, AUD)
  - [ ] Create comprehensive edge case test suite

## Dev Notes

### Previous Story Insights
No previous stories in this epic - this is the foundation story for MP3 naming convention implementation.

### Data Models
Based on the data models, this story will interact with:
- **Recording Model**: `id`, `file_path`, `file_name`, `created_at` [Source: architecture/data-models-refined-and-finalized.md#recording]
- **Metadata Model**: `recording_id`, `key`, `value` for extracting artist, title, year, etc. [Source: architecture/data-models-refined-and-finalized.md#metadata]

### File Locations
Based on project structure, new code should be created in:
- **Main Module**: `services/file_rename_service/src/mp3_naming/` [Source: architecture/source-tree.md]
- **Unit Tests**: `tests/unit/file_rename_service/mp3_naming/` [Source: architecture/test-strategy-and-standards.md#unit-tests]

### Technical Constraints
- **Python Version**: Python 3.13 [Source: architecture/tech-stack.md]
- **Package Management**: All commands must use `uv run` instead of direct python/pip [Source: architecture/coding-standards.md#python-execution-standards]
- **ORM**: SQLAlchemy for database access [Source: architecture/tech-stack.md]
- **Line Length**: Maximum 120 characters [Source: architecture/coding-standards.md]

### Integration Points
Based on service interactions, this module will integrate with:
- **File Rename Service**: Primary service for rename proposal generation [Source: architecture/service-interactions.md#file-rename-service-integration]
- **Analysis Service**: Consumes analysis results and metadata from database [Source: architecture/service-interactions.md#analysis-service-integration]
- **Message Queue**: Receives rename proposal requests via RabbitMQ [Source: architecture/service-interactions.md#message-flow-architecture]

### Testing Standards
- **Framework**: pytest with `uv run pytest` execution [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **File Convention**: `test_*.py` files in `tests/unit/` directory [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Coverage**: Minimum 80% coverage for new code [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- **Test Location**: `tests/unit/file_rename_service/mp3_naming/` following service structure

### Pre-Commit Requirements
- All pre-commit hooks MUST pass: ruff linting, ruff formatting, mypy type checking [Source: architecture/coding-standards.md#pre-commit-workflow]
- Execute via: `uv run pre-commit run --all-files` [Source: architecture/coding-standards.md#pre-commit-workflow]

## Testing

### Testing Standards
- **Test Framework**: pytest executed via `uv run pytest` [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Test Location**: All tests in `tests/unit/file_rename_service/mp3_naming/` directory [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Naming Convention**: Test files named `test_*.py` [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Coverage Requirement**: Minimum 80% code coverage for all new code [Source: architecture/test-strategy-and-standards.md#testing-philosophy]

### Testing Requirements for This Story
- Unit tests for all public methods in naming convention classes
- Edge case testing for character restrictions and invalid inputs
- Comprehensive test cases validating against MP3 Rules 4.1 compliance
- Cross-platform filesystem compatibility testing
- Performance testing for metadata processing and name generation

### Test Execution Commands
- Run story-specific tests: `uv run pytest tests/unit/file_rename_service/mp3_naming/ -v`
- Run all unit tests: `uv run pytest tests/unit/ -v`
- Run with coverage: `uv run pytest tests/unit/file_rename_service/mp3_naming/ --cov=services.file_rename_service.src.mp3_naming --cov-report=term-missing`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-09-04 | 1.0 | Initial story creation for MP3 naming convention core engine | Scrum Master |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by development agent*

### Debug Log References
*To be filled by development agent*

### Completion Notes List
*To be filled by development agent*

### File List
*To be filled by development agent*

## QA Results

*This section will be populated by the QA Agent after story completion*
