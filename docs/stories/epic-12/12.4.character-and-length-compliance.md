# Story 12.4: Character and Length Compliance

## Status
Draft

## Story
**As a** system administrator,
**I want** filesystem-safe naming,
**so that** files work across all platforms

## Acceptance Criteria
1. Enforce character restrictions
2. Handle 255 character limit properly
3. Convert invalid characters safely
4. Truncate intelligently when needed
5. Preserve essential information
6. Test cross-platform compatibility

## Tasks / Subtasks

- [ ] **Task 1: Character Restriction Enforcement (AC: 1)**
  - [ ] Enhance `CharacterSanitizer` class from Story 12.1
  - [ ] Implement strict allowlist: a-z A-Z 0-9 _ . - ()
  - [ ] Create character validation engine with detailed error reporting
  - [ ] Handle Unicode normalization for consistent processing
  - [ ] Implement character-by-character validation pipeline
  - [ ] Create comprehensive character restriction tests

- [ ] **Task 2: 255 Character Limit Handler (AC: 2)**
  - [ ] Create `LengthComplianceManager` class
  - [ ] Calculate total dirname + filename character count
  - [ ] Implement intelligent length checking before name generation
  - [ ] Handle edge cases where metadata exceeds limits
  - [ ] Provide length violation warnings and recommendations
  - [ ] Create length limit validation tests

- [ ] **Task 3: Safe Character Conversion (AC: 3)**
  - [ ] Implement `CharacterConverter` class
  - [ ] Map common invalid characters to safe equivalents
  - [ ] Handle foreign/international character conversion
  - [ ] Process accent marks and special Unicode characters
  - [ ] Maintain readability while ensuring filesystem safety
  - [ ] Create character conversion mapping tests

- [ ] **Task 4: Intelligent Truncation System (AC: 4)**
  - [ ] Create `IntelligentTruncator` class
  - [ ] Prioritize essential elements (artist, title, year) over optional ones
  - [ ] Implement smart truncation that preserves meaning
  - [ ] Handle title vs artist name priority in truncation decisions
  - [ ] Provide truncation strategies for different scenarios
  - [ ] Create truncation logic tests with edge cases

- [ ] **Task 5: Essential Information Preservation (AC: 5)**
  - [ ] Implement `InformationPrioritizer` class
  - [ ] Define priority hierarchy: Artist > Title > Year > Source > Group
  - [ ] Ensure minimum viable information remains after truncation
  - [ ] Handle scenarios where even essential info exceeds limits
  - [ ] Provide fallback naming strategies for extreme cases
  - [ ] Create information preservation tests

- [ ] **Task 6: Cross-Platform Compatibility Testing (AC: 6)**
  - [ ] Create `PlatformCompatibilityTester` class
  - [ ] Test generated names on Windows (NTFS limitations)
  - [ ] Validate compatibility with macOS (HFS+/APFS requirements)
  - [ ] Check Linux filesystem compatibility (ext4, Btrfs)
  - [ ] Handle platform-specific reserved names and characters
  - [ ] Create comprehensive cross-platform test suite

## Dev Notes

### Previous Story Insights
Integrates with all previous stories in Epic 12:
- Extends `CharacterSanitizer` class from Story 12.1 with enhanced functionality
- Works with source tag formatting from Story 12.2 to ensure tagged names comply
- Handles VA compilation names from Story 12.3 with proper length management
- Provides the final validation layer for all naming convention outputs

### Data Models
Uses the same data models as previous stories:
- **Recording Model**: Access to `file_path` and `file_name` for length validation [Source: architecture/data-models-refined-and-finalized.md#recording]
- **Metadata Model**: All metadata fields must be processed for character safety [Source: architecture/data-models-refined-and-finalized.md#metadata]
- **Tracklist Model**: Track artist names and titles from VA releases need character compliance [Source: architecture/data-models-refined-and-finalized.md#tracklist]

### File Locations
Extending the mp3_naming module:
- **Compliance**: `services/file_rename_service/src/mp3_naming/compliance/` [Source: architecture/source-tree.md]
- **Unit Tests**: `tests/unit/file_rename_service/mp3_naming/compliance/` [Source: architecture/test-strategy-and-standards.md#unit-tests]

### Technical Constraints
Same as all previous stories:
- **Python Version**: Python 3.13 [Source: architecture/tech-stack.md]
- **Package Management**: All commands must use `uv run` [Source: architecture/coding-standards.md#python-execution-standards]
- **ORM**: SQLAlchemy for database access [Source: architecture/tech-stack.md]
- **Line Length**: Maximum 120 characters [Source: architecture/coding-standards.md]

### Integration Points
Final validation layer for all previous integration points:
- **File Rename Service**: Ensures all rename proposals meet filesystem constraints [Source: architecture/service-interactions.md#file-rename-service-integration]
- **Analysis Service**: Validates that analysis-derived names are filesystem-safe [Source: architecture/service-interactions.md#analysis-service-integration]
- **Tracklist Service**: Ensures track-based naming is compliant across platforms [Source: architecture/service-interactions.md#tracklist-service-integration]

### MP3 Rules 4.1 Compliance Requirements
Final compliance validation for Epic 12:
- **Character Set**: Only a-z A-Z 0-9 _ . - () allowed in names
- **Length Limit**: Maximum 255 characters for dirname + filename combination
- **Cross-Platform**: Names must work on Windows, macOS, and Linux filesystems
- **Preservation**: Essential information (artist, title, year) must be preserved
- **Fallback**: Graceful handling when metadata exceeds practical limits

### Platform-Specific Considerations
Key filesystem compatibility requirements:
- **Windows NTFS**: Reserved names (CON, PRN, AUX), path length limits
- **macOS APFS/HFS+**: Unicode normalization, case sensitivity considerations
- **Linux ext4/Btrfs**: Unicode support, special character handling
- **General**: Avoid leading/trailing spaces, multiple consecutive dots

### Testing Standards
Same as all previous stories:
- **Framework**: pytest with `uv run pytest` execution [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **File Convention**: `test_*.py` files in `tests/unit/` directory [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Coverage**: Minimum 80% coverage for new code [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- **Test Location**: `tests/unit/file_rename_service/mp3_naming/compliance/`

### Pre-Commit Requirements
Same requirements as all previous stories:
- All pre-commit hooks MUST pass: ruff linting, ruff formatting, mypy type checking [Source: architecture/coding-standards.md#pre-commit-workflow]
- Execute via: `uv run pre-commit run --all-files` [Source: architecture/coding-standards.md#pre-commit-workflow]

## Testing

### Testing Standards
- **Test Framework**: pytest executed via `uv run pytest` [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Test Location**: All tests in `tests/unit/file_rename_service/mp3_naming/compliance/` directory [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Naming Convention**: Test files named `test_*.py` [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Coverage Requirement**: Minimum 80% code coverage for all new code [Source: architecture/test-strategy-and-standards.md#testing-philosophy]

### Testing Requirements for This Story
- Character restriction enforcement with comprehensive invalid character testing
- Length limit validation with various metadata combinations exceeding 255 characters
- Character conversion accuracy testing with international characters and Unicode
- Intelligent truncation testing preserving essential information
- Information preservation testing under extreme length constraints
- Cross-platform compatibility testing on Windows, macOS, and Linux filesystems

### Test Execution Commands
- Run story-specific tests: `uv run pytest tests/unit/file_rename_service/mp3_naming/compliance/ -v`
- Run all unit tests: `uv run pytest tests/unit/ -v`
- Run with coverage: `uv run pytest tests/unit/file_rename_service/mp3_naming/compliance/ --cov=services.file_rename_service.src.mp3_naming.compliance --cov-report=term-missing`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-09-04 | 1.0 | Initial story creation for character and length compliance | Scrum Master |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by development agent*

### Debug Log References
*To be filled by development agent*

### Completion Notes List
*To be filled by development agent*

### File List
*To be filled by development agent*

## QA Results

*This section will be populated by the QA Agent after story completion*
