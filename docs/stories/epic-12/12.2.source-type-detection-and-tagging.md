# Story 12.2: Source Type Detection and Tagging

## Status
Draft

## Story
**As a** release manager,
**I want** proper source tags applied automatically,
**so that** releases are correctly identified

## Acceptance Criteria
1. Detect source type from metadata/context
2. Apply appropriate source tags
3. Support multi-disc notation
4. Handle special cases (bootleg, promo, etc.)
5. Validate source tag combinations
6. Provide manual override options

## Tasks / Subtasks

- [ ] **Task 1: Source Type Detection Engine (AC: 1)**
  - [ ] Create `SourceTypeDetector` class in `mp3_naming` module
  - [ ] Implement metadata analysis for source type hints
  - [ ] Parse file path and directory context for source clues
  - [ ] Analyze recording characteristics (bitrate, format, quality indicators)
  - [ ] Create decision matrix for source type determination
  - [ ] Create unit tests for source detection logic

- [ ] **Task 2: Source Tag Mapping System (AC: 2)**
  - [ ] Implement `SourceTagMapper` class
  - [ ] Map physical media: CD/CDS/CDM, VINYL/VLS/LP, DVD/DVDS, TAPE, FLASH
  - [ ] Map digital sources: WEB, MP3CD, STREAM
  - [ ] Map live sources: FM/SAT/CABLE, SBD, AUD, LINE
  - [ ] Handle broadcast and radio sources with proper tagging
  - [ ] Create comprehensive mapping tests

- [ ] **Task 3: Multi-Disc Support System (AC: 3)**
  - [ ] Implement `MultiDiscDetector` class
  - [ ] Detect multi-disc releases from metadata and file structure
  - [ ] Generate proper notation: -2CD-, -3DVD-, -4LP-, etc.
  - [ ] Handle mixed media releases (CD+DVD combinations)
  - [ ] Validate disc count against actual file structure
  - [ ] Create multi-disc detection test cases

- [ ] **Task 4: Special Case Handler (AC: 4)**
  - [ ] Create `SpecialCaseProcessor` class
  - [ ] Detect bootleg releases and apply -BOOTLEG- tag
  - [ ] Identify promotional releases and apply -PROMO- tag
  - [ ] Handle magazine compilations with -MAG- tag
  - [ ] Process soundtrack releases with -OST- tag
  - [ ] Manage single releases with -SINGLE- tag
  - [ ] Create special case detection tests

- [ ] **Task 5: Source Tag Validation (AC: 5)**
  - [ ] Implement `SourceTagValidator` class
  - [ ] Validate source tag combinations according to MP3 Rules 4.1
  - [ ] Ensure mutually exclusive tags don't conflict
  - [ ] Check required tag presence for specific source types
  - [ ] Validate multi-disc notation format correctness
  - [ ] Create validation rule test suite

- [ ] **Task 6: Manual Override System (AC: 6)**
  - [ ] Create `ManualOverrideManager` class
  - [ ] Implement user preference storage for source type overrides
  - [ ] Allow manual source tag specification in metadata
  - [ ] Provide confidence scoring for automatic detection
  - [ ] Enable user review and correction workflow
  - [ ] Create override functionality tests

## Dev Notes

### Previous Story Insights
Builds on Story 12.1 Core Naming Convention Engine - will use the character sanitization and base naming structures established there.

### Data Models
This story extends the metadata usage from Story 12.1:
- **Recording Model**: Access to `file_path` for directory context analysis [Source: architecture/data-models-refined-and-finalized.md#recording]
- **Metadata Model**: Extended use of `key`, `value` pairs for source detection hints like bitrate, format, quality indicators [Source: architecture/data-models-refined-and-finalized.md#metadata]

### File Locations
Extending the mp3_naming module structure:
- **Source Detection**: `services/file_rename_service/src/mp3_naming/source_detection/` [Source: architecture/source-tree.md]
- **Unit Tests**: `tests/unit/file_rename_service/mp3_naming/source_detection/` [Source: architecture/test-strategy-and-standards.md#unit-tests]

### Technical Constraints
Same as Story 12.1:
- **Python Version**: Python 3.13 [Source: architecture/tech-stack.md]
- **Package Management**: All commands must use `uv run` [Source: architecture/coding-standards.md#python-execution-standards]
- **ORM**: SQLAlchemy for metadata access [Source: architecture/tech-stack.md]
- **Line Length**: Maximum 120 characters [Source: architecture/coding-standards.md]

### Integration Points
Extends Story 12.1 integration points:
- **File Rename Service**: Enhanced rename proposal generation with source-specific tagging [Source: architecture/service-interactions.md#file-rename-service-integration]
- **Analysis Service**: Consumes detailed audio analysis for source type hints (bitrate, quality) [Source: architecture/service-interactions.md#analysis-service-integration]
- **Message Queue**: Source detection triggers via analysis completion events [Source: architecture/service-interactions.md#message-flow-architecture]

### MP3 Rules 4.1 Source Requirements
Based on Epic 12 specification:
- **Physical Media**: CD/CDS/CDM (pressed CDDA), VINYL/VLS/LP, DVD/DVDS, TAPE, FLASH
- **Digital Sources**: WEB (digital downloads), MP3CD, STREAM (internal)
- **Live Sources**: FM/SAT/CABLE (broadcast), SBD (soundboard), AUD (audience), LINE (direct)
- **Special Tags**: -BOOTLEG-, -PROMO-, -MAG-, -OST-, -SINGLE-
- **Multi-Disc**: -2CD-, -3DVD-, etc. notation

### Testing Standards
Same as Story 12.1:
- **Framework**: pytest with `uv run pytest` execution [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **File Convention**: `test_*.py` files in `tests/unit/` directory [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Coverage**: Minimum 80% coverage for new code [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- **Test Location**: `tests/unit/file_rename_service/mp3_naming/source_detection/`

### Pre-Commit Requirements
Same requirements as Story 12.1:
- All pre-commit hooks MUST pass: ruff linting, ruff formatting, mypy type checking [Source: architecture/coding-standards.md#pre-commit-workflow]
- Execute via: `uv run pre-commit run --all-files` [Source: architecture/coding-standards.md#pre-commit-workflow]

## Testing

### Testing Standards
- **Test Framework**: pytest executed via `uv run pytest` [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Test Location**: All tests in `tests/unit/file_rename_service/mp3_naming/source_detection/` directory [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Naming Convention**: Test files named `test_*.py` [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Coverage Requirement**: Minimum 80% code coverage for all new code [Source: architecture/test-strategy-and-standards.md#testing-philosophy]

### Testing Requirements for This Story
- Unit tests for source type detection from various metadata combinations
- Test coverage for all supported source types (physical, digital, live)
- Multi-disc detection accuracy testing with various file structures
- Special case detection testing (bootleg, promo, magazine, OST, single)
- Source tag validation testing for rule compliance and conflict detection
- Manual override functionality and user preference testing

### Test Execution Commands
- Run story-specific tests: `uv run pytest tests/unit/file_rename_service/mp3_naming/source_detection/ -v`
- Run all unit tests: `uv run pytest tests/unit/ -v`
- Run with coverage: `uv run pytest tests/unit/file_rename_service/mp3_naming/source_detection/ --cov=services.file_rename_service.src.mp3_naming.source_detection --cov-report=term-missing`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-09-04 | 1.0 | Initial story creation for source type detection and tagging | Scrum Master |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by development agent*

### Debug Log References
*To be filled by development agent*

### Completion Notes List
*To be filled by development agent*

### File List
*To be filled by development agent*

## QA Results

*This section will be populated by the QA Agent after story completion*
