# Story 12.5: Integration with Existing Services

## Status
Draft

## Story
**As a** developer,
**I want** naming conventions integrated system-wide,
**so that** all services use consistent naming

## Acceptance Criteria
1. Update renaming_service with new conventions
2. Integrate with media_discovery_service
3. Update file organization patterns
4. Maintain backward compatibility
5. Provide migration tools
6. Document integration points

## Tasks / Subtasks

- [ ] **Task 1: File Rename Service Integration (AC: 1)**
  - [ ] Update `FileRenameService` to use MP3 naming convention classes
  - [ ] Integrate `NamingConventionEngine` into rename proposal workflow
  - [ ] Add source type detection to rename decision logic
  - [ ] Implement VA compilation handling in rename proposals
  - [ ] Ensure character and length compliance in all rename operations
  - [ ] Create integration tests for updated rename service

- [ ] **Task 2: Analysis Service Integration (AC: 2)**
  - [ ] Update `AnalysisService` to trigger naming convention processing
  - [ ] Add MP3 naming convention metadata to analysis results
  - [ ] Integrate source type detection with audio analysis pipeline
  - [ ] Ensure naming convention runs after metadata extraction
  - [ ] Add naming convention status to analysis completion events
  - [ ] Create analysis service integration tests

- [ ] **Task 3: File Organization Pattern Updates (AC: 3)**
  - [ ] Update file organization logic to use MP3 naming conventions
  - [ ] Modify directory structure creation to follow dirname patterns
  - [ ] Integrate source tag-based organization strategies
  - [ ] Update VA compilation organization patterns
  - [ ] Ensure consistent naming across all file operations
  - [ ] Create file organization integration tests

- [ ] **Task 4: Backward Compatibility Maintenance (AC: 4)**
  - [ ] Create `LegacyNamingAdapter` class for existing file names
  - [ ] Implement compatibility layer for pre-MP3 naming convention files
  - [ ] Add configuration flags to enable/disable new naming conventions
  - [ ] Ensure existing workflows continue to function during transition
  - [ ] Provide graceful fallback for unsupported naming scenarios
  - [ ] Create backward compatibility tests

- [ ] **Task 5: Migration Tools Development (AC: 5)**
  - [ ] Create `NamingMigrationTool` for converting existing libraries
  - [ ] Implement batch migration processing for large file collections
  - [ ] Add dry-run functionality to preview migration changes
  - [ ] Provide migration progress tracking and reporting
  - [ ] Include rollback functionality for failed migrations
  - [ ] Create migration tool tests and validation

- [ ] **Task 6: Integration Documentation (AC: 6)**
  - [ ] Document MP3 naming convention API and usage patterns
  - [ ] Create integration guide for service developers
  - [ ] Document configuration options and migration procedures
  - [ ] Provide troubleshooting guide for naming convention issues
  - [ ] Create examples for common integration scenarios
  - [ ] Update architectural documentation with new naming patterns

## Dev Notes

### Previous Story Insights
This story integrates all previous Epic 12 stories into the broader system:
- Uses `NamingConventionEngine` from Story 12.1 across services
- Applies source type detection from Story 12.2 system-wide
- Implements VA compilation support from Story 12.3 throughout the pipeline
- Ensures character and length compliance from Story 12.4 in all integrations
- Provides the complete MP3 naming convention system for production use

### Data Models
Uses all data models from previous stories in integrated workflows:
- **Recording Model**: Updated throughout the rename and analysis pipeline [Source: architecture/data-models-refined-and-finalized.md#recording]
- **Metadata Model**: Enhanced with naming convention metadata fields [Source: architecture/data-models-refined-and-finalized.md#metadata]
- **Tracklist Model**: Integrated with VA compilation naming throughout services [Source: architecture/data-models-refined-and-finalized.md#tracklist]

### File Locations
Integration across multiple services:
- **Integration Logic**: `services/file_rename_service/src/integration/` [Source: architecture/source-tree.md]
- **Migration Tools**: `services/file_rename_service/src/migration/` [Source: architecture/source-tree.md]
- **Shared Components**: `services/shared/mp3_naming/` for cross-service access [Source: architecture/source-tree.md]
- **Unit Tests**: `tests/unit/file_rename_service/integration/` and `tests/integration/` [Source: architecture/test-strategy-and-standards.md#unit-tests]

### Technical Constraints
Same as all previous stories with additional integration considerations:
- **Python Version**: Python 3.13 [Source: architecture/tech-stack.md]
- **Package Management**: All commands must use `uv run` [Source: architecture/coding-standards.md#python-execution-standards]
- **ORM**: SQLAlchemy for database access across services [Source: architecture/tech-stack.md]
- **Message Queue**: RabbitMQ for inter-service communication [Source: architecture/tech-stack.md]
- **Line Length**: Maximum 120 characters [Source: architecture/coding-standards.md]

### Integration Points
This story affects all major system integration points:
- **File Rename Service**: Primary service enhanced with MP3 naming conventions [Source: architecture/service-interactions.md#file-rename-service-integration]
- **Analysis Service**: Integrated naming convention processing in analysis pipeline [Source: architecture/service-interactions.md#analysis-service-integration]
- **Cataloging Service**: Updated to use consistent naming patterns [Source: architecture/service-interactions.md#cataloging-service-integration]
- **File Watcher**: Enhanced file organization with MP3 naming standards [Source: architecture/service-interactions.md#file-watcher-integration]
- **Message Queue**: New message types for naming convention events [Source: architecture/service-interactions.md#message-flow-architecture]

### Service Communication Updates
Enhanced message queue patterns for naming convention integration:
- **naming.convention.applied**: Event when MP3 naming is applied to a file
- **naming.validation.required**: Request for naming convention validation
- **migration.status.update**: Progress updates during batch migration
- **compatibility.fallback.triggered**: When legacy naming compatibility is used

### Backward Compatibility Strategy
Critical requirements for existing system integration:
- **Configuration Toggle**: Enable/disable MP3 naming conventions via environment variables
- **Legacy Support**: Maintain support for existing naming patterns during transition
- **Graceful Migration**: Provide tools for gradual migration of existing libraries
- **Fallback Handling**: Automatic fallback to legacy naming when MP3 conventions fail
- **Validation Bridge**: Cross-validate between old and new naming systems

### Testing Standards
Enhanced testing requirements for system integration:
- **Framework**: pytest with `uv run pytest` execution [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Unit Tests**: `tests/unit/file_rename_service/integration/` [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Integration Tests**: `tests/integration/naming_convention/` for cross-service testing [Source: architecture/test-strategy-and-standards.md#integration-tests]
- **Coverage**: Minimum 80% coverage for new code [Source: architecture/test-strategy-and-standards.md#testing-philosophy]

### Pre-Commit Requirements
Same requirements as all previous stories:
- All pre-commit hooks MUST pass: ruff linting, ruff formatting, mypy type checking [Source: architecture/coding-standards.md#pre-commit-workflow]
- Execute via: `uv run pre-commit run --all-files` [Source: architecture/coding-standards.md#pre-commit-workflow]

## Testing

### Testing Standards
- **Test Framework**: pytest executed via `uv run pytest` [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Test Location**: Unit tests in `tests/unit/file_rename_service/integration/` directory [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Integration Tests**: `tests/integration/naming_convention/` for cross-service testing [Source: architecture/test-strategy-and-standards.md#integration-tests]
- **Naming Convention**: Test files named `test_*.py` [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Coverage Requirement**: Minimum 80% code coverage for all new code [Source: architecture/test-strategy-and-standards.md#testing-philosophy]

### Testing Requirements for This Story
- Service integration testing with MP3 naming conventions enabled
- Cross-service communication testing for naming convention events
- Backward compatibility testing with existing file naming patterns
- Migration tool testing with various file library configurations
- End-to-end workflow testing from file detection through naming application
- Performance testing for batch operations and large-scale migrations

### Test Execution Commands
- Run story-specific unit tests: `uv run pytest tests/unit/file_rename_service/integration/ -v`
- Run integration tests: `uv run pytest tests/integration/naming_convention/ -v`
- Run all unit tests: `uv run pytest tests/unit/ -v`
- Run with coverage: `uv run pytest tests/unit/file_rename_service/integration/ --cov=services.file_rename_service.src.integration --cov-report=term-missing`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-09-04 | 1.0 | Initial story creation for service integration | Scrum Master |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by development agent*

### Debug Log References
*To be filled by development agent*

### Completion Notes List
*To be filled by development agent*

### File List
*To be filled by development agent*

## QA Results

*This section will be populated by the QA Agent after story completion*
