# Story 3.2: Ogg Vorbis Metadata Extraction

## Story Information
- **Epic**: 3 - Missing File Format (Ogg Vorbis Support)
- **Story Number**: 3.2
- **Status**: Approved
- **Created**: 2025-08-21
- **Updated**: 2025-08-21

## Story Statement
**As a** user organizing my music library,
**I want** the system to extract all metadata from Ogg Vorbis files,
**So that** I can search and organize based on this information.

## Acceptance Criteria
1. All standard Vorbis comments are extracted
2. Technical metadata is accurately captured
3. Custom tags are preserved and accessible
4. Missing metadata is handled gracefully

## Dev Notes

**Previous Story Insights**:
- Story 3.1 implemented basic OGG Vorbis file detection and initial metadata extraction
- The _extract_ogg method in MetadataExtractor class already handles basic Vorbis comments
- Current implementation extracts: title, artist, album, date, genre, track, albumartist, comment, encoder, organization
- Technical metadata extraction includes: duration, bitrate, sample_rate, channels, bitrate_nominal, encoder_version
- OggVorbis class from mutagen.oggvorbis is already imported and in use
- File validation and error handling for corrupted files was partially implemented
[Source: Story 3.1 Dev Agent Record]

**Current Implementation Status**:
- services/analysis_service/src/metadata_extractor.py has _extract_ogg method
- Basic Vorbis comment extraction is functional
- Need to extend for ALL Vorbis comments and custom tags
- Need to improve error handling for missing metadata
[Source: services/analysis_service/src/metadata_extractor.py]

**Vorbis Comment Specification**:
- Vorbis comments are case-insensitive UTF-8 key-value pairs
- Standard fields: TITLE, VERSION, ALBUM, TRACKNUMBER, ARTIST, PERFORMER, COPYRIGHT, LICENSE, ORGANIZATION, DESCRIPTION, GENRE, DATE, LOCATION, CONTACT, ISRC
- Extended fields commonly used: ALBUMARTIST, COMPOSER, CONDUCTOR, DISCNUMBER, DISCTOTAL, TOTALTRACKS, PUBLISHER, LABEL, COMPILATION, LYRICS, LANGUAGE, MOOD, BPM, KEY, REPLAYGAIN_*
- Custom fields: Any field not in standard/extended lists should be preserved with original case
- Multiple values: Vorbis allows multiple values per key (e.g., multiple ARTIST tags)
[Source: architecture/tech-stack.md#metadata-library]

**Technical Stack**:
- **Python**: 3.13
- **Metadata Library**: mutagen (already supports full Vorbis comment access)
- **Database**: PostgreSQL 17 for metadata storage, Neo4j 5.26 for relationships
- **ORM**: SQLAlchemy for database access
[Source: architecture/tech-stack.md]

**Data Model Requirements**:
- Metadata model uses key-value structure (recording_id, key, value)
- Allows unlimited metadata fields without schema changes
- Custom tags should be stored with original field names
- Multiple values per key need special handling (JSON array or separate rows)
[Source: architecture/data-models-refined-and-finalized.md#metadata]

**Error Handling Requirements**:
- Custom exceptions already defined: InvalidAudioFileError, MetadataExtractionError
- Must handle missing tags gracefully (return None or empty string)
- Log errors with correlation ID for tracing
- Structured JSON logging format required
- Handle malformed Vorbis comments without crashing
[Source: architecture/error-handling-strategy.md]

**File Locations**:
- Metadata extractor: services/analysis_service/src/metadata_extractor.py
- Unit tests: tests/unit/analysis_service/
- Integration tests: tests/integration/
[Source: architecture/source-tree.md]

**Testing Requirements**:
- **Framework**: pytest with `uv run pytest` execution
- **Test Location**: tests/unit/analysis_service/ for metadata extraction tests
- **Coverage Goal**: Minimum 80% for new code
- **Test Cases Required**:
  - Standard Vorbis comments extraction
  - Extended field extraction
  - Custom tag preservation
  - Multiple value handling
  - Missing tag graceful handling
  - Malformed comment handling
  - Empty file handling
[Source: architecture/test-strategy-and-standards.md]

**Implementation Approach**:
- Enhance _extract_ogg method to extract ALL Vorbis comments, not just predefined ones
- Implement dynamic field extraction for custom tags
- Handle multiple values per key appropriately
- Add comprehensive error handling with logging
- Ensure backwards compatibility with existing code
[Source: Epic 3 technical considerations]

## Tasks / Subtasks

### 1. Enhance Standard Vorbis Comment Extraction (AC: 1)
- [x] Update _extract_ogg to extract all standard Vorbis comment fields
- [x] Add extraction for: VERSION, PERFORMER, COPYRIGHT, LICENSE, DESCRIPTION, LOCATION, CONTACT, ISRC
- [x] Add extraction for extended fields: COMPOSER, CONDUCTOR, DISCNUMBER, DISCTOTAL, TOTALTRACKS, PUBLISHER, LABEL
- [x] Add extraction for audio-specific fields: COMPILATION, LYRICS, LANGUAGE, MOOD, BPM, KEY
- [x] Add extraction for ReplayGain tags: REPLAYGAIN_TRACK_GAIN, REPLAYGAIN_TRACK_PEAK, REPLAYGAIN_ALBUM_GAIN, REPLAYGAIN_ALBUM_PEAK
- [x] Write unit tests for all standard field extraction

### 2. Implement Custom Tag Preservation (AC: 3)
- [x] Modify _extract_ogg to iterate through ALL tags in the file
- [x] Create a method to identify and preserve non-standard tags
- [x] Store custom tags with their original field names (case-preserved)
- [x] Implement a separate "custom_tags" dictionary in the metadata response
- [x] Ensure custom tags don't override standard tag extraction
- [x] Write unit tests for custom tag extraction with various field names

### 3. Handle Multiple Values Per Key (AC: 1, 3)
- [x] Detect when a Vorbis comment has multiple values for the same key
- [x] Implement strategy for multiple values (JSON array or delimited string)
- [x] Special handling for multiple ARTIST, PERFORMER, GENRE tags
- [x] Document the multiple value handling approach
- [x] Write unit tests for files with multiple values per tag

### 4. Improve Technical Metadata Extraction (AC: 2)
- [x] Add extraction for additional OGG-specific technical fields
- [x] Extract version information from the OGG container
- [x] Add quality indicators (VBR/CBR detection, quality setting if available)
- [x] Extract encoder settings if present in comments
- [x] Calculate and store file size metadata
- [x] Write unit tests for technical metadata extraction

### 5. Enhance Error Handling for Missing Metadata (AC: 4)
- [x] Update _extract_ogg to handle None values gracefully
- [x] Implement fallback values for missing required fields
- [x] Add detailed logging for missing or malformed tags
- [x] Handle corrupted Vorbis comment blocks without failing entire extraction
- [x] Implement partial extraction when some metadata is unreadable
- [x] Write unit tests for various error scenarios

### 6. Add Validation and Sanitization (AC: 4)
- [x] Validate UTF-8 encoding of all Vorbis comments
- [x] Sanitize field values to prevent injection attacks
- [x] Handle extremely long field values appropriately
- [x] Validate date formats and convert to standard format
- [x] Implement maximum field count limits for safety
- [x] Write unit tests for validation scenarios

### 7. Update Documentation and Integration
- [x] Document all supported Vorbis comment fields
- [x] Update service README with OGG metadata details
- [x] Document custom tag handling approach
- [x] Add examples of extracted metadata structure
- [x] Ensure integration with cataloging service handles new fields
- [x] Write integration tests for end-to-end metadata flow

## Project Structure Notes
This story extends the OGG Vorbis support implemented in Story 3.1 by making the metadata extraction comprehensive and robust. The implementation should maintain backward compatibility while adding the ability to extract ALL Vorbis comments, not just a predefined set. The focus is on completeness, reliability, and proper error handling.

## Testing

### Testing Standards
- **Test Execution**: All tests must use `uv run pytest` (never `pytest` directly)
- **Test Location**: Unit tests in `tests/unit/analysis_service/`
- **Test Naming**: Files named `test_*.py`, functions named `test_*`
- **Coverage Goal**: Minimum 80% coverage for new code
- **Pre-commit**: Must pass all hooks before commit
  - Run: `uv run pre-commit run --all-files`
  - Includes: ruff linting, ruff formatting, mypy type checking
- **Task Completion**: Cannot mark task complete until:
  1. Implementation complete
  2. Unit tests written and passing
  3. Pre-commit hooks passing
  4. Code committed with descriptive message

### Test Cases Required
1. **Standard Fields**: Test extraction of all standard Vorbis comment fields
2. **Extended Fields**: Test audio-specific and ReplayGain fields
3. **Custom Tags**: Test preservation of non-standard tags
4. **Multiple Values**: Test handling of duplicate keys
5. **Missing Fields**: Test graceful handling of missing metadata
6. **Malformed Data**: Test handling of corrupted Vorbis comments
7. **Edge Cases**: Empty files, huge tags, special characters

### Story Completion Requirements
1. All tasks marked complete
2. All unit tests passing (`uv run pytest tests/unit/analysis_service/ -v`)
3. Integration tests passing (`uv run pytest tests/integration/ -v`)
4. Pre-commit hooks passing
5. Code coverage â‰¥80% for new code
6. Story documentation updated
7. All code committed and pushed

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-21 | 1.0 | Initial story creation from Epic 3 requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (claude-opus-4-1-20250805)

### Debug Log References
- Enhanced OGG metadata extraction implementation
- Custom tag preservation with JSON serialization
- Multiple value handling with semicolon joining
- Validation and sanitization methods
- Technical metadata extraction with VBR/CBR detection

### Completion Notes
Successfully enhanced the OGG Vorbis metadata extraction to be comprehensive and robust. The implementation now:
- Extracts ALL standard and extended Vorbis comment fields
- Preserves custom tags with original case in JSON format
- Handles multiple values per key by joining with semicolons
- Includes comprehensive error handling and validation
- Detects VBR vs CBR and extracts file size
- Has 15 comprehensive unit tests covering all scenarios

### File List
**Modified:**
- services/analysis_service/src/metadata_extractor.py
- services/analysis_service/README.md
- docs/stories/3.2.story.md

**Created:**
- tests/unit/analysis_service/test_ogg_metadata_enhanced.py
- tests/integration/test_ogg_metadata_integration.py

## QA Results
_To be filled by QA agent_
