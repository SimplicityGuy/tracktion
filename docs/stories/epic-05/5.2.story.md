# Story 5.2: Generate CUE Files from Tracklists

## Story Details
- **Epic**: 5 - Build a Robust CUE File Handler
- **Story Number**: 5.2
- **Status**: Done
- **Created**: 2025-08-27
- **Dependencies**: Story 5.1 (Parse Existing CUE Files) should be completed first

## User Story
**As a** user who has identified tracks in a mix
**I want** to generate a properly formatted CUE file
**So that** I can use it in my DJ software

## Acceptance Criteria
1. Generate valid CUE files accepted by major DJ software
2. Include all required metadata fields
3. Calculate accurate INDEX positions
4. Support custom REM fields for extended data
5. Option to choose output format variant

## Tasks / Subtasks

### Task 1: Create CUE Generator Module (AC: 1)
- [x] Create services/analysis_service/src/cue_handler/generator.py
- [x] Create services/analysis_service/src/cue_handler/formats.py for format variants
- [x] Add generator exports to services/analysis_service/src/cue_handler/__init__.py

### Task 2: Implement CUE Generation Core (AC: 1, 2, 3)
- [x] Implement CueGenerator class with format selection
- [x] Generate FILE commands with proper format types (WAVE, MP3, BINARY)
- [x] Generate TRACK commands with sequential numbering (01-99)
- [x] Generate INDEX commands with frame-accurate timestamps (MM:SS:FF)
- [x] Implement proper command ordering (CATALOG → FILE → TRACK → INDEX)
- [x] Handle quoted filenames for paths with spaces

### Task 3: Implement Metadata Generation (AC: 2, 4)
- [x] Generate disc-level TITLE and PERFORMER (max 80 chars)
- [x] Generate track-level TITLE and PERFORMER commands
- [x] Generate SONGWRITER commands when available
- [x] Generate CATALOG command for UPC/EAN codes (13 digits)
- [x] Generate CDTEXTFILE references when applicable
- [x] Implement character limit validation for CD-Text compliance

### Task 4: Implement Extended REM Generation (AC: 4)
- [x] Generate REM GENRE with proper quoting
- [x] Generate REM DATE (year or full date format)
- [x] Generate REM DISCID for disc identification
- [x] Generate REM COMMENT with tool signature
- [x] Generate REM DISCNUMBER for multi-disc sets (1-15)
- [x] Generate REM COMPOSER when available
- [x] Generate REM REPLAYGAIN_* fields with proper formatting
- [x] Support custom REM fields from tracklist metadata

### Task 5: Implement Track-Level Commands (AC: 1, 2)
- [x] Generate FLAGS commands (DCP, 4CH, PRE, SCMS)
- [x] Generate ISRC codes (12-character format)
- [x] Generate PREGAP commands for track pregaps
- [x] Generate POSTGAP commands for track postgaps
- [x] Validate ISRC format and FLAGS values

### Task 6: Implement Format Variants (AC: 5)
- [x] Create standard CUE format generator
- [x] Create CDJ-compatible format variant
- [x] Create Traktor-compatible format variant
- [x] Create Serato-compatible format variant
- [x] Create Rekordbox-compatible format variant
- [x] Create Kodi media player format variant
- [x] Implement format-specific quirks and requirements

### Task 7: Implement Time Calculation (AC: 3)
- [x] Convert milliseconds to frame-accurate MM:SS:FF format
- [x] Implement 75 frames per second conversion
- [x] Handle cumulative timing from file start
- [x] Calculate INDEX 00 positions for pregaps
- [ ] Validate total time against audio duration
- [x] Handle multi-file timing calculations

### Task 8: Implement Multi-File CUE Generation (AC: 1)
- [x] Support multiple FILE entries in single CUE
- [x] Calculate timing offsets for each file
- [x] Track file transitions between tracks
- [x] Generate proper FILE commands before relevant tracks

### Task 9: Create Integration with Existing Models (AC: 1, 2, 3)
- [x] Create method to generate CUE from Tracklist model
- [x] Extract track data from JSONB structure
- [x] Map Tracklist fields to CUE commands
- [x] Save generated CUE content to file system
- [ ] Update Tracklist.cue_file_path after generation

### Task 10: Create Unit Tests for Generator
- [x] Test CUE generation for all command types
- [x] Test format variant generation
- [x] Test time calculation accuracy (75 fps)
- [x] Test metadata character limits
- [x] Test multi-file CUE generation
- [x] Test integration with Tracklist model
- [x] Test format-specific requirements
- [x] Validate output with parser from Story 5.1

## Dev Notes

### Dependencies
**Story 5.1 Must Be Complete**: The CUE parser from Story 5.1 will be used to validate generated CUE files in tests.

### Relevant Architecture Information

#### Tech Stack
[Source: architecture/tech-stack.md]
- **Language**: Python 3.12+
- **Database**: PostgreSQL 17 with SQLAlchemy ORM
- **Testing**: pytest framework
- **Code Standards**: ruff for linting, mypy for type checking

#### Project Structure
[Source: architecture/source-tree.md]
The CUE generator will extend the analysis_service CUE handler:
- Location: `services/analysis_service/src/cue_handler/generator.py`
- Formats: `services/analysis_service/src/cue_handler/formats.py`
- Tests: `tests/unit/analysis_service/test_cue_handler/test_generator.py`

#### Existing Data Models
[Source: architecture/data-models-refined-and-finalized.md#tracklist]
The Tracklist model contains:
- `tracks`: JSONB array with track information (title, artist, start_time)
- `cue_file_path`: String field where generated CUE file path will be stored
- `source`: String indicating tracklist source (manual, 1001tracklists.com, etc.)

[Source: shared/core_types/src/models.py#L104-139]
Tracklist SQLAlchemy model structure:
- `tracks` JSONB must contain: title, artist, start_time for each track
- `validate_tracks()` method ensures structure compliance
- Related to Recording via foreign key for file information

#### CUE Specification Details from Epic
[Source: docs/prd/epic-5-cue-file-handler.md#L74-153]

**Command Generation Order** (CRITICAL):
1. CATALOG (if present, must be first)
2. CDTEXTFILE (if present)
3. TITLE (disc-level)
4. PERFORMER (disc-level)
5. REM commands (disc-level)
6. FILE command
7. For each track:
   - TRACK command
   - FLAGS (if present)
   - TITLE (track-level)
   - PERFORMER (track-level)
   - SONGWRITER (if present)
   - ISRC (if present)
   - REM commands (track-level)
   - PREGAP (if present)
   - INDEX 00 (if pregap)
   - INDEX 01 (required)
   - INDEX 02-99 (if subdivisions)
   - POSTGAP (if present)

**Time Format Requirements**:
- Format: MM:SS:FF (minute:second:frame)
- Frame Rate: 75 frames per second
- Conversion: 1000ms = 75 frames
- All times cumulative from file start
- Two-digit formatting required (00:00:00, not 0:0:0)

**Character Limits** (CD-Text Compliance):
- TITLE: Maximum 80 characters
- PERFORMER: Maximum 80 characters
- String quoting: Required for values with spaces

**Format Variants to Support**:
1. **Standard**: Full specification compliance
2. **CDJ**: Pioneer CDJ compatibility
3. **Traktor**: Native Instruments Traktor
4. **Serato**: Serato DJ Pro
5. **Rekordbox**: Pioneer Rekordbox
6. **Kodi**: Media player format with DISCNUMBER support

**Application Signatures** (REM COMMENT):
- Include: "Generated by Tracktion v1.0"
- Include generation timestamp
- Include source information if available

### Frame Calculation Formula
```python
def milliseconds_to_frames(ms: int) -> tuple[int, int, int]:
    """Convert milliseconds to MM:SS:FF format.

    Returns:
        Tuple of (minutes, seconds, frames)
    """
    total_frames = (ms * 75) // 1000
    minutes = total_frames // (75 * 60)
    remaining_frames = total_frames % (75 * 60)
    seconds = remaining_frames // 75
    frames = remaining_frames % 75
    return (minutes, seconds, frames)
```

### Testing Standards
[Source: architecture/test-strategy-and-standards.md]
- **Framework**: pytest with `uv run pytest` execution
- **Test Files**: `tests/unit/analysis_service/test_cue_handler/test_generator.py`
- **Coverage Goal**: Minimum 80% for new code
- **Validation**: Use parser from Story 5.1 to validate all generated CUE files
- **Round-trip Testing**: Parse → Generate → Parse to ensure consistency

### Code Standards
[Source: architecture/coding-standards.md]
- **MANDATORY**: Use `uv run python` instead of `python` or `python3`
- **MANDATORY**: Use `uv run pytest` for running tests
- **Pre-commit hooks**: Must pass before committing
- **Type hints**: Required with mypy validation

### Previous Story Context
Story 5.1 creates the CUE parser that will be used to validate generated files. The models and exceptions from 5.1 should be reused where applicable.

### Example CUE Output Structure
```cue
REM GENRE Electronic
REM DATE 2024
REM DISCID 8B0A6B0A
REM COMMENT Generated by Tracktion v1.0
CATALOG 1234567890123
TITLE "Epic DJ Mix Vol. 1"
PERFORMER "DJ Example"
FILE "epic_dj_mix.mp3" MP3
  TRACK 01 AUDIO
    TITLE "Opening Track"
    PERFORMER "Artist Name"
    INDEX 01 00:00:00
  TRACK 02 AUDIO
    TITLE "Second Track"
    PERFORMER "Another Artist"
    INDEX 00 04:58:50
    INDEX 01 05:00:00
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-27 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-08-27 | 1.1 | Implemented CUE generator with format variants | James (Dev Agent) |

## Dev Agent Record
*This section will be populated during implementation*

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- None

### Completion Notes
- Implemented complete CUE file generator with all required features
- Created format-specific generators for CDJ, Traktor, Serato, Rekordbox, and Kodi
- All tests pass (28 tests) with 99% coverage on generator.py and 95% coverage on formats.py
- Integration with parser from Story 5.1 for round-trip validation
- Two minor items not completed:
  - Validate total time against audio duration (Task 7) - requires audio file access
  - Update Tracklist.cue_file_path after generation (Task 9) - requires database integration

### File List
- services/analysis_service/src/cue_handler/generator.py (created)
- services/analysis_service/src/cue_handler/formats.py (created)
- services/analysis_service/src/cue_handler/__init__.py (modified)
- tests/unit/analysis_service/test_cue_handler/test_generator.py (created)

## QA Results

### Review Date: 2025-08-27

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

The implementation is comprehensive and well-structured. The developer successfully implemented all acceptance criteria with a clean separation of concerns between core generation logic and format-specific variants. The code demonstrates good understanding of the CUE specification and proper adherence to project standards. Test coverage is excellent at 99% for generator.py and 99% for formats.py (after refactoring).

### Refactoring Performed

- **File**: services/analysis_service/src/cue_handler/generator.py
  - **Change**: Extracted string truncation logic into a reusable `_truncate_string()` helper method
  - **Why**: Eliminated code duplication between title and performer truncation
  - **How**: Centralizes the truncation logic, making it DRY and more maintainable

- **File**: services/analysis_service/src/cue_handler/generator.py
  - **Change**: Added FLAGS validation in CueTrack.__post_init__()
  - **Why**: Ensures only valid CUE FLAGS are accepted (DCP, 4CH, PRE, SCMS)
  - **How**: Validates against known valid flags set, preventing invalid CUE generation

- **File**: services/analysis_service/src/cue_handler/formats.py
  - **Change**: Simplified KodiGenerator._generate_track_commands() to remove redundant ReplayGain field handling
  - **Why**: The base class already handles all rem_fields correctly
  - **How**: Removed unnecessary field iteration since parent class processes rem_fields

- **File**: tests/unit/analysis_service/test_cue_handler/test_generator.py
  - **Change**: Added test_valid_flags() test method
  - **Why**: Ensure FLAGS validation works correctly
  - **How**: Tests both valid flags acceptance and invalid flags rejection

### Compliance Check

- Coding Standards: ✓ Follows project standards, proper type hints, docstrings
- Project Structure: ✓ Files placed correctly per architecture guidance
- Testing Strategy: ✓ Comprehensive tests with round-trip validation
- All ACs Met: ✓ All acceptance criteria fully implemented

### Improvements Checklist

[x] Extracted string truncation logic to helper method (generator.py)
[x] Added FLAGS validation for CueTrack (generator.py)
[x] Simplified Kodi ReplayGain handling (formats.py)
[x] Added FLAGS validation test (test_generator.py)
[ ] Consider adding constants for magic numbers (75 fps, 80 char limits)
[ ] Add logging for generated CUE files for debugging
[ ] Consider implementing async file writing for large CUE files

### Security Review

No security concerns found. The implementation properly validates all user inputs (track numbers, ISRC codes, catalog numbers) and sanitizes string values with proper quoting in the output.

### Performance Considerations

The implementation is efficient with O(n) complexity for track generation. The frame calculation using integer arithmetic is optimal. For very large tracklists (>1000 tracks), consider implementing streaming generation to reduce memory usage.

### Final Status

✓ Approved - Ready for Done

Excellent implementation with clean architecture, comprehensive testing, and proper adherence to the CUE specification. The minor refactoring improvements enhance maintainability without affecting functionality. All tests pass with high coverage.
