# Story 8.2: Async Database Operations

## Status
Approved

## Story
**As a** system with high database load,
**I want** all database operations to be non-blocking,
**so that** queries don't block other operations

## Acceptance Criteria
1. All database queries use async drivers
2. Connection pooling implemented
3. Concurrent query execution
4. Transaction support maintained
5. Performance improvement measurable

## Tasks / Subtasks
- [x] Task 1: Install and configure async database drivers (AC: 1)
  - [x] Install asyncpg for PostgreSQL async support
  - [x] Install neo4j async driver for graph database
  - [x] Install aioredis for Redis async operations
  - [x] Update pyproject.toml in cataloging_service and analysis_service

- [x] Task 2: Refactor SQLAlchemy to async (AC: 1, 4)
  - [x] Configure SQLAlchemy for async mode
  - [x] Convert all model definitions to async-compatible
  - [x] Update session management for async context
  - [x] Implement async transaction handling

- [x] Task 3: Implement connection pooling (AC: 2)
  - [x] Configure asyncpg connection pool (min: 10, max: 50)
  - [x] Set up Neo4j async driver pool
  - [x] Configure Redis connection pool
  - [x] Implement connection health checks

- [ ] Task 4: Convert database operations in cataloging_service (AC: 3, 4)
  - [ ] Refactor all CRUD operations to async
  - [ ] Update repository pattern for async
  - [ ] Convert transaction handling to async
  - [ ] Implement async batch operations

- [ ] Task 5: Convert database operations in analysis_service (AC: 3, 4)
  - [ ] Update Neo4j queries to async
  - [ ] Convert Redis cache operations to async
  - [ ] Refactor data aggregation queries
  - [ ] Implement async streaming for large datasets

- [ ] Task 6: Migration and compatibility (AC: 4)
  - [ ] Update Alembic migrations for async support
  - [ ] Create async migration runner
  - [ ] Ensure backward compatibility during transition
  - [ ] Test rollback procedures

- [ ] Task 7: Performance testing and optimization (AC: 5)
  - [ ] Benchmark query performance (before/after)
  - [ ] Test concurrent query execution
  - [ ] Measure connection pool efficiency
  - [ ] Optimize slow queries for async

- [ ] Task 8: Update tests for async database operations (AC: All)
  - [ ] Convert database tests to async
  - [ ] Add tests for connection pooling
  - [ ] Test transaction rollback scenarios
  - [ ] Ensure 80% code coverage

## Dev Notes

### Relevant Architecture Context

#### Data Models
[Source: architecture/data-models-refined-and-finalized.md]
- **Recording**: Central entity with id (UUID), file_path, file_name, created_at
- **Metadata**: Key-value pairs linked to Recording via recording_id
- **Tracklist**: Linked to Recording, contains tracks (JSONB), source, cue_file_path
- Relationships: Recording HAS_METADATA (many), Recording HAS_TRACKLIST (one)

#### Database Schema
[Source: architecture/database-schema-refined-and-finalized.md]
PostgreSQL tables:
- recordings (id, file_path, file_name, sha256_hash, xxh128_hash, created_at)
- tracklists (id, recording_id, source, cue_file_path, tracks)
- metadata (id, recording_id, key, value)
- Indexes on metadata.recording_id and metadata.key

Neo4j schema:
- Recording nodes with uuid property
- Metadata nodes with key/value properties
- Tracklist nodes with source property
- Relationships: HAS_METADATA, HAS_TRACKLIST, CONTAINS_TRACK

#### Tech Stack
[Source: architecture/tech-stack.md]
- PostgreSQL 17 (primary data store)
- Neo4j 5.26 (graph database)
- Redis 7.4 (caching)
- SQLAlchemy (ORM) - latest version
- Alembic (migrations) - latest version

#### Project Structure
[Source: architecture/source-tree.md]
Database operations in:
- `services/cataloging_service/src/` - PostgreSQL operations
- `services/analysis_service/src/` - Neo4j and Redis operations
- `shared/core_types/` - Shared data models
- `tests/unit/cataloging_service/` - Cataloging tests
- `tests/unit/analysis_service/` - Analysis tests

#### Async Libraries to Implement
[Source: Epic 7 PRD]
- **asyncpg**: PostgreSQL async driver
- **motor**: MongoDB async driver (if needed)
- **aioredis**: Redis async operations
- **neo4j-python-driver**: Async support for Neo4j
- **SQLAlchemy 2.0+**: Async ORM support

#### Performance Targets
[Source: Epic 7 PRD]
- Connection pool: 20-50 connections
- Query response time: <100ms for 95th percentile
- Support 1000+ concurrent database operations
- Transaction support with proper rollback
- Batch processing optimization

### Critical Implementation Details
- Use async context managers for connections
- Implement proper connection cleanup
- Handle connection timeouts gracefully
- Use prepared statements where possible
- Implement query result streaming for large datasets
- Maintain transaction isolation levels

### Testing Requirements
[Source: architecture/test-strategy-and-standards.md]
- Test files in `tests/unit/*/` directories
- Use `uv run pytest` for execution
- Integration tests require Docker environments
- Test transaction rollback scenarios
- Verify connection pool behavior
- Minimum 80% code coverage

### Coding Standards
[Source: architecture/coding-standards.md]
- Database queries only through ORM/repository layer
- Connection strings from environment variables
- No direct database queries outside repository
- Proper error handling for connection failures
- Use type hints for all async functions

### Migration Considerations
[Source: Epic 7 PRD]
- Compatibility layer for sync/async transition
- Feature flags for gradual rollout
- Parallel testing of both implementations
- Performance metrics collection
- Rollback plan for critical failures

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-28 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)
