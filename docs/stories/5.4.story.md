# Story 5.4: Validate CUE File Integrity

## Story Details
- **Epic**: 5 - Build a Robust CUE File Handler
- **Story Number**: 5.4
- **Status**: Draft
- **Created**: 2025-08-27
- **Dependencies**: Story 5.1 (Parser) should be completed first

## User Story
**As a** user working with CUE files
**I want** validation of CUE file correctness
**So that** I can ensure they work properly

## Acceptance Criteria
1. Verify syntax correctness
2. Validate referenced audio files exist
3. Check timestamp consistency and boundaries
4. Ensure total time matches audio duration
5. Report all issues with clear descriptions

## Tasks / Subtasks

### Task 1: Create CUE Validator Module (AC: 1, 2, 3, 4, 5)
- [ ] Create services/analysis_service/src/cue_handler/validator.py
- [ ] Create services/analysis_service/src/cue_handler/validation_rules.py
- [ ] Create services/analysis_service/src/cue_handler/audio_analyzer.py
- [ ] Add validator exports to services/analysis_service/src/cue_handler/__init__.py

### Task 2: Implement CueValidator Class (AC: 1, 5)
- [ ] Create CueValidator class using parser from Story 5.1
- [ ] Implement validate() method returning ValidationResult
- [ ] Create ValidationResult class with errors, warnings, and info
- [ ] Implement severity levels (ERROR, WARNING, INFO)
- [ ] Add line number tracking for all issues
- [ ] Support batch validation of multiple files

### Task 3: Implement Syntax Validation Rules (AC: 1)
- [ ] Validate command syntax and structure
- [ ] Check required commands presence (FILE, TRACK, INDEX 01)
- [ ] Validate command parameters format
- [ ] Check character limits (80 chars for TITLE/PERFORMER)
- [ ] Validate ISRC format (12 characters, alphanumeric)
- [ ] Validate CATALOG format (13 digits UPC/EAN)
- [ ] Check FLAGS values (DCP, 4CH, PRE, SCMS only)

### Task 4: Implement Command Order Validation (AC: 1)
- [ ] Validate CATALOG appears before FILE
- [ ] Validate FILE appears before its TRACKs
- [ ] Validate TRACK commands are sequential (01, 02, 03...)
- [ ] Validate INDEX ordering within tracks (00 before 01)
- [ ] Check for duplicate track numbers
- [ ] Validate proper nesting of disc/track commands

### Task 5: Implement File Reference Validation (AC: 2)
- [ ] Check if referenced audio files exist
- [ ] Check file paths (relative vs absolute)
- [ ] Validate file format matches declaration (WAVE, MP3, etc.)
- [ ] Detect and report missing files with full paths
- [ ] Check file permissions and readability
- [ ] Support multi-file CUE validation

### Task 6: Implement Audio Analysis Integration (AC: 4)
- [ ] Create audio duration extraction using mutagen/pydub
- [ ] Compare CUE total time vs actual audio duration
- [ ] Validate individual track times within audio bounds
- [ ] Check for tracks extending beyond file duration
- [ ] Calculate and report time discrepancies
- [ ] Support multiple audio format analysis

### Task 7: Implement Timestamp Validation (AC: 3)
- [ ] Validate MM:SS:FF format correctness
- [ ] Check frame values are 0-74 (75 fps)
- [ ] Verify times are cumulative and increasing
- [ ] Detect overlapping track times
- [ ] Check for negative time gaps
- [ ] Validate pregap/postgap timing logic
- [ ] Ensure INDEX 00 < INDEX 01 when both present

### Task 8: Implement Cross-Reference Validation (AC: 1, 3)
- [ ] Validate PREGAP duration matches INDEX positions
- [ ] Check POSTGAP doesn't overlap next track
- [ ] Verify multi-file CUE timing continuity
- [ ] Validate track count matches actual content
- [ ] Check for orphaned or unreferenced data
- [ ] Validate REM field value formats

### Task 9: Implement Compatibility Checks (AC: 1, 5)
- [ ] Check compatibility with CDJ requirements
- [ ] Validate Traktor-specific requirements
- [ ] Check Serato compatibility rules
- [ ] Validate Rekordbox format requirements
- [ ] Check Kodi media player compatibility
- [ ] Report format-specific issues separately

### Task 10: Implement Validation Reporting (AC: 5)
- [ ] Create detailed validation report structure
- [ ] Group issues by severity and category
- [ ] Include fix suggestions for common issues
- [ ] Generate human-readable error messages
- [ ] Support JSON/text report output formats
- [ ] Add summary statistics (errors/warnings/info counts)
- [ ] Include validation timestamp and file info

### Task 11: Implement Auto-Fix Suggestions (AC: 5)
- [ ] Suggest fixes for common syntax errors
- [ ] Recommend timestamp adjustments
- [ ] Propose character limit corrections
- [ ] Suggest file path corrections
- [ ] Provide command reordering solutions
- [ ] Generate diff-style fix proposals

### Task 12: Create Unit Tests for Validator
- [ ] Test all validation rule categories
- [ ] Test with valid CUE files from various sources
- [ ] Test with intentionally malformed CUE files
- [ ] Test audio duration validation
- [ ] Test multi-file CUE validation
- [ ] Test compatibility checks for each format
- [ ] Test validation report generation
- [ ] Test auto-fix suggestions

## Dev Notes

### Dependencies
**Story 5.1 Must Be Complete**: The CUE parser from Story 5.1 is required for loading and analyzing CUE files.

### Relevant Architecture Information

#### Tech Stack
[Source: architecture/tech-stack.md]
- **Language**: Python 3.13
- **Testing**: pytest framework
- **Code Standards**: ruff for linting, mypy for type checking

#### Project Structure
[Source: architecture/source-tree.md]
The CUE validator will extend the analysis_service CUE handler:
- Location: `services/analysis_service/src/cue_handler/validator.py`
- Rules: `services/analysis_service/src/cue_handler/validation_rules.py`
- Audio: `services/analysis_service/src/cue_handler/audio_analyzer.py`
- Tests: `tests/unit/analysis_service/test_cue_handler/test_validator.py`

#### CUE Validation Specifications
[Source: docs/prd/epic-5-cue-file-handler.md#L74-153]

**Critical Validation Rules**:

1. **Command Structure**:
   - FILE must include filename and format type
   - TRACK must have number (01-99) and type (AUDIO, etc.)
   - INDEX must have number (00-99) and time (MM:SS:FF)

2. **Command Order** (MUST validate):
   ```
   CATALOG (optional, but must be first if present)
   CDTEXTFILE (optional)
   TITLE (disc-level, optional)
   PERFORMER (disc-level, optional)
   REM (disc-level, optional, multiple allowed)
   FILE (required)
     TRACK (required, 01-99)
       FLAGS (optional)
       TITLE (track-level, optional)
       PERFORMER (track-level, optional)
       SONGWRITER (optional)
       ISRC (optional)
       REM (track-level, optional, multiple allowed)
       PREGAP (optional)
       INDEX 00 (optional, pregap start)
       INDEX 01 (required, track start)
       INDEX 02-99 (optional, subdivisions)
       POSTGAP (optional)
   ```

3. **Time Validation**:
   - Format: MM:SS:FF where FF is 0-74 (75 frames/second)
   - Times must be cumulative from file start
   - No overlapping track times
   - INDEX 00 < INDEX 01 when both present
   - Total time should not exceed audio file duration

4. **Format Constraints**:
   - CATALOG: 13 digits only (UPC/EAN)
   - ISRC: 12 characters (country[2] + registrant[3] + year[2] + code[5])
   - TITLE/PERFORMER: Maximum 80 characters (CD-Text limit)
   - FLAGS: Only DCP, 4CH, PRE, SCMS allowed

5. **File Validation**:
   - Referenced files must exist and be readable
   - File format must match declaration (WAVE for .wav, MP3 for .mp3)
   - FLAC files typically use WAVE type for compatibility

### Validation Severity Levels
```python
class Severity(Enum):
    ERROR = "error"      # Prevents CUE from working
    WARNING = "warning"  # May cause issues in some software
    INFO = "info"        # Suggestions for improvement

# Examples:
ERROR: Missing required INDEX 01
ERROR: Referenced audio file not found
ERROR: Invalid time format
WARNING: TITLE exceeds 80 character limit
WARNING: Non-standard REM field detected
INFO: Consider adding ISRC for track identification
```

### Audio Duration Analysis
```python
def analyze_audio_duration(file_path: str) -> float:
    """Get audio file duration in milliseconds.

    Uses mutagen for metadata extraction, falls back to pydub
    for direct audio analysis if needed.
    """
    from mutagen import File
    from pydub import AudioSegment

    try:
        # Try mutagen first (faster)
        audio = File(file_path)
        if audio and audio.info:
            return audio.info.length * 1000  # Convert to ms
    except:
        pass

    try:
        # Fall back to pydub (more formats)
        audio = AudioSegment.from_file(file_path)
        return len(audio)  # Already in ms
    except:
        return 0  # Cannot determine duration
```

### Validation Report Structure
```python
@dataclass
class ValidationIssue:
    severity: Severity
    line_number: Optional[int]
    category: str  # "syntax", "timing", "file", "format", etc.
    message: str
    suggestion: Optional[str]

@dataclass
class ValidationResult:
    file_path: str
    is_valid: bool  # True if no ERRORS
    errors: List[ValidationIssue]
    warnings: List[ValidationIssue]
    info: List[ValidationIssue]
    audio_duration_ms: Optional[float]
    cue_duration_ms: Optional[float]
    format_compatibility: Dict[str, bool]  # {"CDJ": True, "Traktor": False, ...}

    def to_report(self) -> str:
        """Generate human-readable report."""
        pass

    def to_json(self) -> dict:
        """Generate JSON report for programmatic use."""
        pass
```

### Common Issues and Auto-Fix Suggestions
1. **Missing INDEX 01**: Add INDEX 01 at track start
2. **Time overlap**: Adjust subsequent track times
3. **Exceeds audio duration**: Trim last track time
4. **Character limit exceeded**: Truncate with "..."
5. **Wrong file path**: Suggest relative path from CUE location
6. **Invalid ISRC**: Format as XX-XXX-YY-NNNNN
7. **Track gap**: Suggest INDEX 00 for pregap

### Testing Standards
[Source: architecture/test-strategy-and-standards.md]
- **Framework**: pytest with `uv run pytest` execution
- **Test Files**: `tests/unit/analysis_service/test_cue_handler/test_validator.py`
- **Coverage Goal**: Minimum 80% for new code
- **Test Data**: Create sample CUE files with various issues for testing

### Code Standards
[Source: architecture/coding-standards.md]
- **MANDATORY**: Use `uv run python` instead of `python` or `python3`
- **MANDATORY**: Use `uv run pytest` for running tests
- **Pre-commit hooks**: Must pass before committing
- **Type hints**: Required with mypy validation

### Integration with Existing Models
[Source: shared/core_types/src/models.py#L104-139]
The validator can be used to:
1. Validate CUE files before saving to Tracklist.cue_file_path
2. Ensure Tracklist.tracks JSONB matches CUE content
3. Validate against Recording file_path and duration

### Example Usage
```python
from cue_handler import CueValidator

# Validate a single CUE file
validator = CueValidator()
result = validator.validate("mix.cue")

if not result.is_valid:
    print(f"Validation failed with {len(result.errors)} errors")
    for error in result.errors:
        print(f"Line {error.line_number}: {error.message}")
        if error.suggestion:
            print(f"  Suggestion: {error.suggestion}")
else:
    print("CUE file is valid!")
    if result.warnings:
        print(f"Found {len(result.warnings)} warnings")

# Generate report
report = result.to_report()
print(report)
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-27 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent after implementation*
