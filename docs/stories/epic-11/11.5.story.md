# Story 11.5: Static Analysis Compliance

## Status
Not Started

## Story
**As a** code reviewer
**I want** full static analysis compliance
**So that** code quality is consistently high

## Acceptance Criteria
1. Zero mypy errors
2. Zero ruff violations
3. All type hints present
4. No suppressed warnings (except documented necessities)
5. Clean pre-commit runs
6. CI/CD pipeline fully green

## Tasks / Subtasks

### Task 1: MyPy Compliance (AC: 1, 3, 4)
- [ ] Run mypy on all services and catalog errors
- [ ] Fix import-related type errors
- [ ] Add missing type annotations to functions
- [ ] Fix incompatible type assignments
- [ ] Resolve Optional/None handling issues
- [ ] Add type stubs for third-party libraries
- [ ] Fix generic type parameter issues
- [ ] Resolve async/await type problems
- [ ] Add return type annotations
- [ ] Configure mypy.ini for strict checking

### Task 2: Ruff Linting Compliance (AC: 2, 4)
- [ ] Run ruff on all services and catalog violations
- [ ] Fix import ordering issues (I001)
- [ ] Resolve naming convention violations (N8xx)
- [ ] Fix line length issues (E501)
- [ ] Address complexity warnings (C901)
- [ ] Remove unused imports (F401)
- [ ] Fix undefined name errors (F821)
- [ ] Resolve docstring issues (D4xx)
- [ ] Fix code style violations
- [ ] Configure ruff.toml for project standards

### Task 3: Type Annotation Coverage (AC: 3)
- [ ] Add type hints to all function signatures
- [ ] Add return type annotations
- [ ] Type class attributes properly
- [ ] Add generic type parameters where needed
- [ ] Use Protocol types for duck typing
- [ ] Add TypeAlias for complex types
- [ ] Implement TypedDict for dictionaries
- [ ] Use Literal types for constants
- [ ] Add overload signatures where applicable
- [ ] Document type annotation patterns

### Task 4: Pre-commit Hook Configuration (AC: 5)
- [ ] Update .pre-commit-config.yaml
- [ ] Configure mypy pre-commit hook
- [ ] Configure ruff pre-commit hook
- [ ] Add black formatter hook
- [ ] Add isort import sorter
- [ ] Configure trailing whitespace fixer
- [ ] Add end-of-file fixer
- [ ] Configure check-yaml hook
- [ ] Add check-json hook
- [ ] Test all hooks work correctly

### Task 5: CI/CD Pipeline Updates (AC: 6)
- [ ] Add mypy check to CI pipeline
- [ ] Add ruff check to CI pipeline
- [ ] Configure failure on violations
- [ ] Add static analysis reports
- [ ] Set up violation trending
- [ ] Configure PR blocking on failures
- [ ] Add performance metrics
- [ ] Create quality gates
- [ ] Add badge generation
- [ ] Configure notification on failures

### Task 6: Service-Specific Fixes (AC: 1, 2)
- [ ] Fix analysis_service static analysis issues
- [ ] Fix tracklist_service static analysis issues
- [ ] Fix file_watcher static analysis issues
- [ ] Update shared libraries compliance
- [ ] Fix test file static analysis
- [ ] Update configuration files
- [ ] Fix migration scripts
- [ ] Update utility modules
- [ ] Fix example code
- [ ] Validate all fixes

### Task 7: Complex Type Issues (AC: 1, 3)
- [ ] Fix SQLAlchemy model typing
- [ ] Resolve Pydantic model issues
- [ ] Fix async function signatures
- [ ] Handle Union type narrowing
- [ ] Fix dataclass type issues
- [ ] Resolve enum typing problems
- [ ] Fix decorator type preservation
- [ ] Handle context manager types
- [ ] Fix generator/iterator types
- [ ] Document complex type patterns

### Task 8: Third-Party Library Types (AC: 1, 3)
- [ ] Install type stubs for major libraries
- [ ] Create custom stubs for missing types
- [ ] Fix redis-py type issues
- [ ] Resolve aio-pika type problems
- [ ] Fix httpx/requests typing
- [ ] Handle numpy/pandas types if used
- [ ] Fix SQLAlchemy 2.0 types
- [ ] Resolve Alembic typing
- [ ] Add types for testing libraries
- [ ] Document stub management

### Task 9: Documentation and Standards (AC: All)
- [ ] Create type annotation guide
- [ ] Document mypy configuration
- [ ] Create ruff rule explanations
- [ ] Write static analysis best practices
- [ ] Document exception handling patterns
- [ ] Create code review checklist
- [ ] Write troubleshooting guide
- [ ] Document CI/CD integration
- [ ] Create onboarding guide
- [ ] Add code quality metrics

## Static Analysis Commands

### MyPy Analysis
```bash
# Run mypy on all services
uv run mypy services/

# Run with strict mode
uv run mypy --strict services/

# Run on specific service
uv run mypy services/analysis_service/

# Show error codes
uv run mypy --show-error-codes services/

# Generate report
uv run mypy --html-report mypy-report services/
```

### Ruff Linting
```bash
# Run ruff check
uv run ruff check services/

# Run with auto-fix
uv run ruff check --fix services/

# Show all violations
uv run ruff check --show-fixes services/

# Run specific rules
uv run ruff check --select E,F,I services/

# Format code
uv run ruff format services/
```

### Pre-commit Validation
```bash
# Run all pre-commit hooks
pre-commit run --all-files

# Run specific hook
pre-commit run mypy --all-files

# Update hooks
pre-commit autoupdate

# Install hooks
pre-commit install
```

## Common Type Annotation Patterns

### Function Signatures
```python
from typing import Optional, List, Dict, Any, Union, Callable

# Basic function
def process_data(input: str) -> Dict[str, Any]:
    ...

# Optional parameters
def fetch_data(id: int, cache: Optional[bool] = None) -> List[str]:
    ...

# Async function
async def async_operation(data: bytes) -> Optional[str]:
    ...

# Callback type
def register_callback(func: Callable[[str], None]) -> None:
    ...
```

### Class Typing
```python
from typing import ClassVar, TypeVar, Generic

T = TypeVar('T')

class Container(Generic[T]):
    items: List[T]
    max_size: ClassVar[int] = 100

    def __init__(self, items: List[T]) -> None:
        self.items = items
```

### Complex Types
```python
from typing import TypedDict, Protocol, Literal

class ConfigDict(TypedDict):
    host: str
    port: int
    debug: bool

class Comparable(Protocol):
    def __lt__(self, other: Any) -> bool: ...

Status = Literal["pending", "processing", "complete"]
```

## Configuration Files

### mypy.ini
```ini
[mypy]
python_version = 3.11
warn_return_any = True
warn_unused_configs = True
disallow_untyped_defs = True
disallow_any_unimported = False
no_implicit_optional = True
check_untyped_defs = True
warn_redundant_casts = True
warn_unused_ignores = True
warn_no_return = True
```

### ruff.toml
```toml
line-length = 100
target-version = "py311"

[lint]
select = ["E", "F", "I", "N", "W", "C90", "UP", "B", "A", "C4", "DJ", "EM", "ISC", "PIE", "PT", "Q", "RET", "SIM", "TID", "ARG", "DTZ", "ERA", "PD", "PGH", "PL", "TRY", "RSE", "SLF"]
ignore = ["E501", "B008"]

[format]
quote-style = "double"
indent-style = "space"
```

## Quality Metrics

### Type Coverage Goals
- Function signatures: 100%
- Return types: 100%
- Class attributes: 95%
- Variable annotations: 80%

### Linting Goals
- Zero E (error) violations
- Zero F (failure) violations
- Minimal W (warning) violations
- Documented exceptions only

### CI/CD Goals
- All checks passing
- <2 minute analysis time
- Automated reporting
- Zero manual interventions

## Dependencies
- mypy with latest version
- ruff with latest version
- pre-commit framework
- Type stub packages
- CI/CD pipeline access

## Definition of Done
- [ ] Zero mypy errors in all services
- [ ] Zero ruff violations (except documented)
- [ ] 100% type annotation on public APIs
- [ ] Pre-commit hooks passing
- [ ] CI/CD pipeline fully green
- [ ] Configuration files optimized
- [ ] Type stubs installed/created
- [ ] Documentation complete
- [ ] Team trained on standards
- [ ] Metrics dashboard created
- [ ] Code review completed

## Dev Agent Record
- [Work Session 1]: Initial static analysis assessment
- [Work Session 2]: MyPy compliance fixes
- [Work Session 3]: Ruff linting fixes
- [Work Session 4]: Type annotation additions
- [Work Session 5]: CI/CD integration
- [Work Session 6]: Final validation and documentation
