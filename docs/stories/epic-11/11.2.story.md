# Story 11.2: Discord-Only Notification System

## Status
Not Started

## Story
**As a** development team
**I want** a single, consistent Discord notification system
**So that** we have clear, maintainable alerting without multi-channel complexity

## Acceptance Criteria
1. Remove ALL Slack code, tests, and references
2. Remove ALL email/SMTP code, tests, and references
3. Implement Discord-only AlertChannel enum
4. Create channel-specific Discord webhook URLs
5. Define clear environment variables for each alert type
6. Update AlertManager to support channel routing
7. Remove multi-channel complexity from alert routing
8. Update all tests to verify Discord-only behavior
9. Update all documentation with Discord configuration

## Tasks / Subtasks

### Task 1: Remove Slack Implementation (AC: 1)
- [ ] Search for all Slack-related code across services
- [ ] Remove SlackAlertChannel enum values
- [ ] Delete slack_alert_handler.py or similar files
- [ ] Remove Slack configuration from settings/config files
- [ ] Delete all Slack-specific tests
- [ ] Remove Slack dependencies from pyproject.toml
- [ ] Remove SLACK_* environment variables from .env files
- [ ] Update any Slack-related error handling
- [ ] Remove Slack webhook URL validations
- [ ] Clean up Slack-related imports

### Task 2: Remove Email/SMTP Implementation (AC: 2)
- [ ] Search for all email/SMTP-related code
- [ ] Remove EmailAlertChannel enum values
- [ ] Delete email_alert_handler.py or similar files
- [ ] Remove SMTP configuration from settings
- [ ] Delete all email-specific tests
- [ ] Remove email dependencies (smtplib, email packages)
- [ ] Remove EMAIL_* and SMTP_* environment variables
- [ ] Remove email template files if any exist
- [ ] Clean up email validation logic
- [ ] Remove email formatting utilities

### Task 3: Implement Discord-Only Alert System (AC: 3, 4, 5)
- [ ] Create new AlertType enum with Discord channels
- [ ] Implement Discord webhook configuration
- [ ] Create DiscordAlertHandler class
- [ ] Add webhook URL validation
- [ ] Implement rate limiting for Discord API
- [ ] Add retry logic for failed sends
- [ ] Create Discord message formatting utilities
- [ ] Implement embed support for rich notifications
- [ ] Add attachment support for logs/reports
- [ ] Create alert batching for high-volume scenarios

### Task 4: Configure Channel-Specific Webhooks (AC: 4, 5, 6)
- [ ] Define DISCORD_WEBHOOK_GENERAL environment variable
- [ ] Define DISCORD_WEBHOOK_ERRORS environment variable
- [ ] Define DISCORD_WEBHOOK_CRITICAL environment variable
- [ ] Define DISCORD_WEBHOOK_TRACKLIST environment variable
- [ ] Define DISCORD_WEBHOOK_MONITORING environment variable
- [ ] Define DISCORD_WEBHOOK_SECURITY environment variable
- [ ] Create webhook URL validation on startup
- [ ] Implement fallback to general channel if specific unavailable
- [ ] Add webhook health check functionality
- [ ] Create channel routing logic in AlertManager

### Task 5: Update Alert Manager (AC: 6, 7)
- [ ] Refactor AlertManager to use single Discord handler
- [ ] Remove multi-channel routing complexity
- [ ] Implement channel selection based on alert type
- [ ] Add message priority levels
- [ ] Create alert aggregation for related messages
- [ ] Implement alert suppression for duplicate messages
- [ ] Add metrics collection for alert frequency
- [ ] Create alert history logging
- [ ] Add alert acknowledgment tracking
- [ ] Implement quiet hours configuration

### Task 6: Update Tests (AC: 8)
- [ ] Remove all Slack-specific test files
- [ ] Remove all email-specific test files
- [ ] Create comprehensive Discord handler tests
- [ ] Test webhook URL validation
- [ ] Test channel routing logic
- [ ] Test rate limiting behavior
- [ ] Test retry logic on failures
- [ ] Test message formatting
- [ ] Test embed generation
- [ ] Mock Discord API responses
- [ ] Test error scenarios
- [ ] Verify alert batching
- [ ] Test configuration validation

### Task 7: Update Documentation (AC: 9)
- [ ] Update README with Discord setup instructions
- [ ] Create Discord webhook creation guide
- [ ] Document channel configuration strategy
- [ ] Update environment variable documentation
- [ ] Create alert type mapping documentation
- [ ] Document rate limits and retry behavior
- [ ] Add troubleshooting guide for Discord issues
- [ ] Update API documentation for alert endpoints
- [ ] Create monitoring setup documentation
- [ ] Add example Discord configurations

### Task 8: Migration and Cleanup (AC: All)
- [ ] Create migration script for existing configurations
- [ ] Update deployment configurations
- [ ] Update CI/CD environment variables
- [ ] Clean up unused notification code
- [ ] Remove deprecated configuration files
- [ ] Update docker-compose files
- [ ] Verify all services use new notification system
- [ ] Test end-to-end alert flow
- [ ] Validate production readiness

## Technical Implementation

### Alert Type Definition
```python
from enum import Enum

class AlertType(Enum):
    GENERAL = "general"
    ERROR = "error"
    CRITICAL = "critical"
    TRACKLIST = "tracklist"
    MONITORING = "monitoring"
    SECURITY = "security"

class AlertPriority(Enum):
    LOW = 1
    MEDIUM = 2
    HIGH = 3
    CRITICAL = 4
```

### Webhook Configuration
```python
import os
from typing import Dict

class DiscordConfig:
    webhooks: Dict[AlertType, str] = {
        AlertType.GENERAL: os.getenv("DISCORD_WEBHOOK_GENERAL"),
        AlertType.ERROR: os.getenv("DISCORD_WEBHOOK_ERRORS"),
        AlertType.CRITICAL: os.getenv("DISCORD_WEBHOOK_CRITICAL"),
        AlertType.TRACKLIST: os.getenv("DISCORD_WEBHOOK_TRACKLIST"),
        AlertType.MONITORING: os.getenv("DISCORD_WEBHOOK_MONITORING"),
        AlertType.SECURITY: os.getenv("DISCORD_WEBHOOK_SECURITY"),
    }

    rate_limit: int = int(os.getenv("DISCORD_RATE_LIMIT", "10"))
    retry_attempts: int = int(os.getenv("DISCORD_RETRY_ATTEMPTS", "3"))
    timeout_seconds: int = int(os.getenv("DISCORD_TIMEOUT_SECONDS", "10"))
```

### Discord Message Format
```python
class DiscordMessage:
    def __init__(self, alert_type: AlertType, title: str, description: str):
        self.embed = {
            "title": title,
            "description": description,
            "color": self._get_color(alert_type),
            "timestamp": datetime.utcnow().isoformat(),
            "footer": {
                "text": f"Tracktion Alert System - {alert_type.value}"
            }
        }

    def _get_color(self, alert_type: AlertType) -> int:
        colors = {
            AlertType.GENERAL: 0x7289DA,    # Blue
            AlertType.ERROR: 0xF04747,      # Red
            AlertType.CRITICAL: 0xFF0000,   # Bright Red
            AlertType.TRACKLIST: 0x43B581,  # Green
            AlertType.MONITORING: 0xFAA61A, # Yellow
            AlertType.SECURITY: 0x9B59B6,   # Purple
        }
        return colors.get(alert_type, 0x7289DA)
```

### Search Commands
```bash
# Find Slack references
rg "slack|Slack|SLACK" --type py

# Find email/SMTP references
rg "email|Email|EMAIL|smtp|SMTP|mail" --type py

# Find notification tests
find . -path "*/test*" -name "*notif*" -o -name "*alert*"

# Find environment variables
rg "SLACK_|EMAIL_|SMTP_" .env* docker-compose*
```

## Dependencies
- httpx or requests library for Discord webhooks
- No external notification service dependencies
- Environment variables must be configured
- Discord server and webhooks must be created

## Definition of Done
- [ ] All Slack code completely removed
- [ ] All email/SMTP code completely removed
- [ ] Discord-only system fully implemented
- [ ] All 6 webhook types configured and tested
- [ ] AlertManager refactored for simplicity
- [ ] All tests updated and passing
- [ ] Documentation complete and accurate
- [ ] Environment variables documented
- [ ] Migration completed successfully
- [ ] Production deployment validated
- [ ] No references to Slack or email remain
- [ ] Code review approved

## Dev Agent Record
- [Work Session 1]: Remove Slack implementation
- [Work Session 2]: Remove email/SMTP implementation
- [Work Session 3]: Implement Discord handler
- [Work Session 4]: Configure webhooks and routing
- [Work Session 5]: Update tests and documentation
- [Work Session 6]: Migration and final validation
