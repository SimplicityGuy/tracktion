# Story 11.1: Pragma Audit and Removal

## Status
Not Started

## Story
**As a** development team
**I want** minimal pragma usage in the codebase
**So that** we're fixing issues rather than hiding them

## Acceptance Criteria
1. Complete audit of ALL mypy, ruff, and linting pragma directives
2. Validate each pragma exception for necessity
3. Fix ALL issues where a proper solution exists
4. Remove unnecessary suppressions that can be properly fixed
5. Fix underlying type checking and linting issues
6. Document remaining pragmas with clear technical justification
7. Create pragma usage guidelines for exceptional cases only
8. Zero new pragmas without explicit justification

## Tasks / Subtasks

### Task 1: Pragma Discovery and Cataloging (AC: 1, 2)
- [ ] Search for all `# type: ignore` comments across codebase
- [ ] Search for all `# noqa` comments across codebase
- [ ] Search for all `# pragma` directives
- [ ] Search for all `# pylint` suppressions
- [ ] Search for all `# mypy` specific directives
- [ ] Create comprehensive catalog with file, line, and reason
- [ ] Categorize pragmas by type (type checking, linting, coverage, etc.)
- [ ] Identify patterns in pragma usage

### Task 2: Type Checking Pragma Resolution (AC: 3, 4, 5)
- [ ] Review each `# type: ignore` for validity
- [ ] Fix import-related type ignores with proper stubs or type definitions
- [ ] Resolve attribute access type errors with proper typing
- [ ] Fix callable/function signature type issues
- [ ] Address generic type parameter problems
- [ ] Update third-party library type stubs where needed
- [ ] Remove all fixable type: ignore comments
- [ ] Test type checking after each batch of fixes

### Task 3: Linting Pragma Resolution (AC: 3, 4, 5)
- [ ] Review each `# noqa` directive for validity
- [ ] Fix naming convention violations (N806, etc.)
- [ ] Resolve import ordering issues
- [ ] Address line length violations with proper refactoring
- [ ] Fix complexity warnings through refactoring
- [ ] Resolve unused variable/import warnings
- [ ] Remove all fixable noqa comments
- [ ] Run ruff after each batch of fixes

### Task 4: Document Required Pragmas (AC: 6, 7)
- [ ] For each remaining pragma, document why it cannot be removed
- [ ] Create technical justification for each exception
- [ ] Add inline comments explaining the necessity
- [ ] Create central documentation of all accepted pragmas
- [ ] Define criteria for when pragmas are acceptable
- [ ] Create review process for new pragma additions
- [ ] Add pre-commit hook to flag undocumented pragmas

### Task 5: Establish Pragma Guidelines (AC: 7, 8)
- [ ] Create pragma usage policy document
- [ ] Define approval process for new pragmas
- [ ] Set up automated pragma detection in CI/CD
- [ ] Create pragma review checklist for PRs
- [ ] Document common pragma alternatives
- [ ] Add pragma count metrics to code quality reports
- [ ] Create training materials on fixing vs suppressing

### Task 6: Validation and Testing (AC: All)
- [ ] Run full mypy check with no suppressions
- [ ] Run full ruff check with no suppressions
- [ ] Verify all tests still pass
- [ ] Check for any runtime issues from fixes
- [ ] Validate CI/CD pipeline passes
- [ ] Review code coverage for any impacts
- [ ] Document final pragma count and locations

## Technical Notes

### Common Pragma Patterns to Fix
```python
# Instead of:
from alembic import context  # type: ignore[attr-defined]
# Fix with:
from alembic import context  # Alembic adds attributes at runtime

# Instead of:
X, y = trainer._prepare_training_data(data)  # noqa: N806
# Fix with proper naming or document ML convention:
X, y = trainer._prepare_training_data(data)  # X is standard ML convention for features

# Instead of:
result = complex_function()  # type: ignore[no-untyped-call]
# Fix with:
# Add type hints to complex_function or create stub file
```

### Search Commands
```bash
# Find all pragmas
rg "# type: ignore|# noqa|# pragma|# pylint|# mypy" --type py

# Count by type
rg "# type: ignore" --type py -c | wc -l
rg "# noqa" --type py -c | wc -l

# Find specific pragma types
rg "# type: ignore\[.*?\]" --type py -o | sort | uniq -c
```

### Validation Commands
```bash
# Run strict type checking
uv run mypy services/ --strict

# Run comprehensive linting
uv run ruff check services/ --no-fix

# Pre-commit validation
pre-commit run --all-files
```

## Dependencies
- All services must have tests passing before pragma removal
- Type stubs may need updates for third-party libraries
- Some framework-specific pragmas may be unavoidable

## Definition of Done
- [ ] All pragmas audited and cataloged
- [ ] All fixable issues resolved without suppressions
- [ ] Required pragmas documented with justification
- [ ] Guidelines created and approved
- [ ] CI/CD validates pragma usage
- [ ] All tests passing
- [ ] Type checking clean (except documented exceptions)
- [ ] Linting clean (except documented exceptions)
- [ ] Documentation complete
- [ ] Code review approved

## Dev Agent Record
- [Work Session 1]: Pragma discovery and cataloging
- [Work Session 2]: Type checking pragma fixes
- [Work Session 3]: Linting pragma fixes
- [Work Session 4]: Documentation and guidelines
- [Work Session 5]: Final validation and cleanup
