# Story 7.4: Validate Multi-Instance Support

## Status
Draft

## Story
**As a** system architect,
**I want** to run multiple file_watcher instances,
**so that** I can monitor multiple directories simultaneously

## Acceptance Criteria
1. Multiple containers can run without conflicts
2. Each instance has unique identification
3. Message queue handles multiple publishers
4. No database conflicts
5. Proper logging identifies instance source

## Tasks / Subtasks
- [ ] Task 1: Implement instance identification (AC: 2,5)
  - [ ] Generate unique instance ID on startup
  - [ ] Include instance ID in all log messages
  - [ ] Add instance ID to RabbitMQ message headers
  - [ ] Store instance ID in environment variable

- [ ] Task 2: Configure RabbitMQ for multiple publishers (AC: 3)
  - [ ] Ensure unique connection names per instance
  - [ ] Verify message routing works correctly
  - [ ] Test queue handling with concurrent publishers
  - [ ] Add instance metadata to messages

- [ ] Task 3: Prevent database conflicts (AC: 4)
  - [ ] Review database operations for race conditions
  - [ ] Implement proper transaction isolation
  - [ ] Use unique constraints appropriately
  - [ ] Handle duplicate key errors gracefully

- [ ] Task 4: Update logging configuration (AC: 5)
  - [ ] Add instance ID to log format
  - [ ] Include watched directory in logs
  - [ ] Configure log aggregation friendly output
  - [ ] Ensure logs are distinguishable per instance

- [ ] Task 5: Create multi-instance test environment (AC: 1)
  - [ ] Create docker-compose with multiple file_watchers
  - [ ] Configure different directories for each instance
  - [ ] Set up shared RabbitMQ and database
  - [ ] Document test environment setup

- [ ] Task 6: Stress testing with multiple instances (AC: All)
  - [ ] Run 3-5 instances simultaneously
  - [ ] Generate file events in all watched directories
  - [ ] Monitor for conflicts or errors
  - [ ] Verify all events are processed correctly
  - [ ] Check resource usage and performance

- [ ] Task 7: Create operational documentation (AC: All)
  - [ ] Document multi-instance deployment
  - [ ] Provide docker-compose examples
  - [ ] Include monitoring recommendations
  - [ ] Create troubleshooting guide

## Dev Notes

### Relevant Architecture Context

#### Service Location
[Source: architecture/source-tree.md]
- File watcher: `services/file_watcher/`
- Docker compose: `infrastructure/docker-compose.yaml`
- RabbitMQ config: `infrastructure/rabbitmq/definitions.json`

#### Multi-Instance Requirements
[Source: Epic 7 PRD]
- Multiple instances monitoring different directories
- No conflicts in message queue
- No database conflicts
- Clear instance identification in logs

#### Implementation Approach

##### Instance ID Generation
```python
import uuid
import os

# Generate unique instance ID
instance_id = os.environ.get('INSTANCE_ID') or str(uuid.uuid4())[:8]
watched_dir = os.environ.get('DATA_DIR', '/data/music')

# Include in logging
logging.basicConfig(
    format=f'%(asctime)s - [{instance_id}:{watched_dir}] - %(name)s - %(levelname)s - %(message)s'
)
```

##### RabbitMQ Configuration
```python
# Unique connection name
connection_params = pika.ConnectionParameters(
    host='rabbitmq',
    client_properties={'connection_name': f'file_watcher_{instance_id}'}
)

# Add instance metadata to messages
message = {
    'instance_id': instance_id,
    'watched_directory': watched_dir,
    'event_type': 'file_created',
    'file_path': file_path,
    'timestamp': datetime.utcnow().isoformat()
}
```

##### Docker Compose Multi-Instance
```yaml
version: '3.8'
services:
  file_watcher_1:
    build: ./services/file_watcher
    environment:
      - INSTANCE_ID=watcher1
      - DATA_DIR=/data/music
    volumes:
      - /host/music:/data/music

  file_watcher_2:
    build: ./services/file_watcher
    environment:
      - INSTANCE_ID=watcher2
      - DATA_DIR=/data/downloads
    volumes:
      - /host/downloads:/data/downloads

  file_watcher_3:
    build: ./services/file_watcher
    environment:
      - INSTANCE_ID=watcher3
      - DATA_DIR=/data/imports
    volumes:
      - /host/imports:/data/imports
```

#### Database Conflict Prevention
- Use INSERT ... ON CONFLICT for upserts
- Proper transaction isolation levels
- Retry logic for transient failures
- Unique constraints on file paths/hashes

#### Testing Scenarios
1. Simultaneous file creation in different directories
2. Same file copied to multiple watched directories
3. High volume of events across instances
4. Instance failure and recovery
5. Database connection pool limits

### Testing Requirements
[Source: architecture/test-strategy-and-standards.md]
- Integration tests with multiple containers
- Stress testing required
- Monitor for race conditions
- Document test scenarios

### Coding Standards
[Source: architecture/coding-standards.md]
- Proper error handling
- Clear logging with context
- Thread-safe operations
- Resource cleanup on shutdown

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-28 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)
