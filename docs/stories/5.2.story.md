# Story 5.2: Generate CUE Files from Tracklists

## Story Details
- **Epic**: 5 - Build a Robust CUE File Handler
- **Story Number**: 5.2
- **Status**: Draft
- **Created**: 2025-08-27
- **Dependencies**: Story 5.1 (Parse Existing CUE Files) should be completed first

## User Story
**As a** user who has identified tracks in a mix
**I want** to generate a properly formatted CUE file
**So that** I can use it in my DJ software

## Acceptance Criteria
1. Generate valid CUE files accepted by major DJ software
2. Include all required metadata fields
3. Calculate accurate INDEX positions
4. Support custom REM fields for extended data
5. Option to choose output format variant

## Tasks / Subtasks

### Task 1: Create CUE Generator Module (AC: 1)
- [ ] Create services/analysis_service/src/cue_handler/generator.py
- [ ] Create services/analysis_service/src/cue_handler/formats.py for format variants
- [ ] Add generator exports to services/analysis_service/src/cue_handler/__init__.py

### Task 2: Implement CUE Generation Core (AC: 1, 2, 3)
- [ ] Implement CueGenerator class with format selection
- [ ] Generate FILE commands with proper format types (WAVE, MP3, BINARY)
- [ ] Generate TRACK commands with sequential numbering (01-99)
- [ ] Generate INDEX commands with frame-accurate timestamps (MM:SS:FF)
- [ ] Implement proper command ordering (CATALOG → FILE → TRACK → INDEX)
- [ ] Handle quoted filenames for paths with spaces

### Task 3: Implement Metadata Generation (AC: 2, 4)
- [ ] Generate disc-level TITLE and PERFORMER (max 80 chars)
- [ ] Generate track-level TITLE and PERFORMER commands
- [ ] Generate SONGWRITER commands when available
- [ ] Generate CATALOG command for UPC/EAN codes (13 digits)
- [ ] Generate CDTEXTFILE references when applicable
- [ ] Implement character limit validation for CD-Text compliance

### Task 4: Implement Extended REM Generation (AC: 4)
- [ ] Generate REM GENRE with proper quoting
- [ ] Generate REM DATE (year or full date format)
- [ ] Generate REM DISCID for disc identification
- [ ] Generate REM COMMENT with tool signature
- [ ] Generate REM DISCNUMBER for multi-disc sets (1-15)
- [ ] Generate REM COMPOSER when available
- [ ] Generate REM REPLAYGAIN_* fields with proper formatting
- [ ] Support custom REM fields from tracklist metadata

### Task 5: Implement Track-Level Commands (AC: 1, 2)
- [ ] Generate FLAGS commands (DCP, 4CH, PRE, SCMS)
- [ ] Generate ISRC codes (12-character format)
- [ ] Generate PREGAP commands for track pregaps
- [ ] Generate POSTGAP commands for track postgaps
- [ ] Validate ISRC format and FLAGS values

### Task 6: Implement Format Variants (AC: 5)
- [ ] Create standard CUE format generator
- [ ] Create CDJ-compatible format variant
- [ ] Create Traktor-compatible format variant
- [ ] Create Serato-compatible format variant
- [ ] Create Rekordbox-compatible format variant
- [ ] Create Kodi media player format variant
- [ ] Implement format-specific quirks and requirements

### Task 7: Implement Time Calculation (AC: 3)
- [ ] Convert milliseconds to frame-accurate MM:SS:FF format
- [ ] Implement 75 frames per second conversion
- [ ] Handle cumulative timing from file start
- [ ] Calculate INDEX 00 positions for pregaps
- [ ] Validate total time against audio duration
- [ ] Handle multi-file timing calculations

### Task 8: Implement Multi-File CUE Generation (AC: 1)
- [ ] Support multiple FILE entries in single CUE
- [ ] Calculate timing offsets for each file
- [ ] Track file transitions between tracks
- [ ] Generate proper FILE commands before relevant tracks

### Task 9: Create Integration with Existing Models (AC: 1, 2, 3)
- [ ] Create method to generate CUE from Tracklist model
- [ ] Extract track data from JSONB structure
- [ ] Map Tracklist fields to CUE commands
- [ ] Save generated CUE content to file system
- [ ] Update Tracklist.cue_file_path after generation

### Task 10: Create Unit Tests for Generator
- [ ] Test CUE generation for all command types
- [ ] Test format variant generation
- [ ] Test time calculation accuracy (75 fps)
- [ ] Test metadata character limits
- [ ] Test multi-file CUE generation
- [ ] Test integration with Tracklist model
- [ ] Test format-specific requirements
- [ ] Validate output with parser from Story 5.1

## Dev Notes

### Dependencies
**Story 5.1 Must Be Complete**: The CUE parser from Story 5.1 will be used to validate generated CUE files in tests.

### Relevant Architecture Information

#### Tech Stack
[Source: architecture/tech-stack.md]
- **Language**: Python 3.13
- **Database**: PostgreSQL 17 with SQLAlchemy ORM
- **Testing**: pytest framework
- **Code Standards**: ruff for linting, mypy for type checking

#### Project Structure
[Source: architecture/source-tree.md]
The CUE generator will extend the analysis_service CUE handler:
- Location: `services/analysis_service/src/cue_handler/generator.py`
- Formats: `services/analysis_service/src/cue_handler/formats.py`
- Tests: `tests/unit/analysis_service/test_cue_handler/test_generator.py`

#### Existing Data Models
[Source: architecture/data-models-refined-and-finalized.md#tracklist]
The Tracklist model contains:
- `tracks`: JSONB array with track information (title, artist, start_time)
- `cue_file_path`: String field where generated CUE file path will be stored
- `source`: String indicating tracklist source (manual, 1001tracklists.com, etc.)

[Source: shared/core_types/src/models.py#L104-139]
Tracklist SQLAlchemy model structure:
- `tracks` JSONB must contain: title, artist, start_time for each track
- `validate_tracks()` method ensures structure compliance
- Related to Recording via foreign key for file information

#### CUE Specification Details from Epic
[Source: docs/prd/epic-5-cue-file-handler.md#L74-153]

**Command Generation Order** (CRITICAL):
1. CATALOG (if present, must be first)
2. CDTEXTFILE (if present)
3. TITLE (disc-level)
4. PERFORMER (disc-level)
5. REM commands (disc-level)
6. FILE command
7. For each track:
   - TRACK command
   - FLAGS (if present)
   - TITLE (track-level)
   - PERFORMER (track-level)
   - SONGWRITER (if present)
   - ISRC (if present)
   - REM commands (track-level)
   - PREGAP (if present)
   - INDEX 00 (if pregap)
   - INDEX 01 (required)
   - INDEX 02-99 (if subdivisions)
   - POSTGAP (if present)

**Time Format Requirements**:
- Format: MM:SS:FF (minute:second:frame)
- Frame Rate: 75 frames per second
- Conversion: 1000ms = 75 frames
- All times cumulative from file start
- Two-digit formatting required (00:00:00, not 0:0:0)

**Character Limits** (CD-Text Compliance):
- TITLE: Maximum 80 characters
- PERFORMER: Maximum 80 characters
- String quoting: Required for values with spaces

**Format Variants to Support**:
1. **Standard**: Full specification compliance
2. **CDJ**: Pioneer CDJ compatibility
3. **Traktor**: Native Instruments Traktor
4. **Serato**: Serato DJ Pro
5. **Rekordbox**: Pioneer Rekordbox
6. **Kodi**: Media player format with DISCNUMBER support

**Application Signatures** (REM COMMENT):
- Include: "Generated by Tracktion v1.0"
- Include generation timestamp
- Include source information if available

### Frame Calculation Formula
```python
def milliseconds_to_frames(ms: int) -> tuple[int, int, int]:
    """Convert milliseconds to MM:SS:FF format.

    Returns:
        Tuple of (minutes, seconds, frames)
    """
    total_frames = (ms * 75) // 1000
    minutes = total_frames // (75 * 60)
    remaining_frames = total_frames % (75 * 60)
    seconds = remaining_frames // 75
    frames = remaining_frames % 75
    return (minutes, seconds, frames)
```

### Testing Standards
[Source: architecture/test-strategy-and-standards.md]
- **Framework**: pytest with `uv run pytest` execution
- **Test Files**: `tests/unit/analysis_service/test_cue_handler/test_generator.py`
- **Coverage Goal**: Minimum 80% for new code
- **Validation**: Use parser from Story 5.1 to validate all generated CUE files
- **Round-trip Testing**: Parse → Generate → Parse to ensure consistency

### Code Standards
[Source: architecture/coding-standards.md]
- **MANDATORY**: Use `uv run python` instead of `python` or `python3`
- **MANDATORY**: Use `uv run pytest` for running tests
- **Pre-commit hooks**: Must pass before committing
- **Type hints**: Required with mypy validation

### Previous Story Context
Story 5.1 creates the CUE parser that will be used to validate generated files. The models and exceptions from 5.1 should be reused where applicable.

### Example CUE Output Structure
```cue
REM GENRE Electronic
REM DATE 2024
REM DISCID 8B0A6B0A
REM COMMENT Generated by Tracktion v1.0
CATALOG 1234567890123
TITLE "Epic DJ Mix Vol. 1"
PERFORMER "DJ Example"
FILE "epic_dj_mix.mp3" MP3
  TRACK 01 AUDIO
    TITLE "Opening Track"
    PERFORMER "Artist Name"
    INDEX 01 00:00:00
  TRACK 02 AUDIO
    TITLE "Second Track"
    PERFORMER "Another Artist"
    INDEX 00 04:58:50
    INDEX 01 05:00:00
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-27 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent after implementation*
