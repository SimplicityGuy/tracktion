# Story 7.2: Configure Docker Data Directory

## Status
Draft

## Story
**As a** DevOps engineer,
**I want** to specify the data directory when running the container,
**so that** I can monitor different directories in different deployments

## Acceptance Criteria
1. Environment variable DATA_DIR is respected
2. Volume mounts work correctly
3. Default directory if not specified
4. Clear documentation of configuration options
5. Container starts successfully with custom directories

## Tasks / Subtasks
- [ ] Task 1: Update Dockerfile for configurable paths (AC: 1,3,5)
  - [ ] Add ENV DATA_DIR with default value
  - [ ] Ensure directory permissions are correct
  - [ ] Create directory if it doesn't exist
  - [ ] Update ENTRYPOINT/CMD to use DATA_DIR

- [ ] Task 2: Modify application to use environment variable (AC: 1,3)
  - [ ] Update file_watcher main.py to read DATA_DIR env var
  - [ ] Implement fallback to default directory
  - [ ] Validate directory exists and is readable
  - [ ] Log the directory being watched on startup

- [ ] Task 3: Update docker-compose configuration (AC: 2,4)
  - [ ] Add volume mount example in docker-compose.yaml
  - [ ] Show environment variable configuration
  - [ ] Document multiple directory monitoring setup
  - [ ] Include example with bind mounts

- [ ] Task 4: Implement path validation (AC: 5)
  - [ ] Check directory exists before starting observer
  - [ ] Verify read permissions on directory
  - [ ] Handle permission errors gracefully
  - [ ] Exit with clear error message if directory invalid

- [ ] Task 5: Create deployment documentation (AC: 4)
  - [ ] Document DATA_DIR environment variable usage
  - [ ] Provide docker run examples with volume mounts
  - [ ] Show docker-compose configuration examples
  - [ ] Include troubleshooting guide for common issues

- [ ] Task 6: Write tests for configuration (AC: All)
  - [ ] Test with DATA_DIR environment variable set
  - [ ] Test with default directory (no env var)
  - [ ] Test with invalid directory path
  - [ ] Test with permission-denied scenarios
  - [ ] Test volume mount functionality

- [ ] Task 7: Integration testing with Docker (AC: 2,5)
  - [ ] Build and test container with default config
  - [ ] Test with custom DATA_DIR via env var
  - [ ] Test with volume mount to host directory
  - [ ] Verify file events are captured from mounted directory

## Dev Notes

### Relevant Architecture Context

#### Service Location
[Source: architecture/source-tree.md]
- Dockerfile: `services/file_watcher/Dockerfile`
- Main service: `services/file_watcher/src/main.py`
- Docker Compose: `infrastructure/docker-compose.yaml`

#### Docker Configuration Requirements
[Source: Epic 7 PRD]
- Must support environment variable configuration
- Must support volume mounts
- Default directory must be provided
- Clear error messages for misconfiguration

#### Implementation Approach

##### Dockerfile Changes
```dockerfile
# Set default data directory
ENV DATA_DIR=/data/music

# Create directory with appropriate permissions
RUN mkdir -p ${DATA_DIR} && chmod 755 ${DATA_DIR}

# Volume declaration (optional, for clarity)
VOLUME ["${DATA_DIR}"]
```

##### Application Changes
```python
import os
import sys

# Get data directory from environment
data_dir = os.environ.get('DATA_DIR', '/data/music')

# Validate directory
if not os.path.exists(data_dir):
    print(f"ERROR: Data directory {data_dir} does not exist")
    sys.exit(1)

if not os.access(data_dir, os.R_OK):
    print(f"ERROR: No read permission for {data_dir}")
    sys.exit(1)

print(f"Monitoring directory: {data_dir}")
```

##### Docker Run Examples
```bash
# Using environment variable
docker run -e DATA_DIR=/custom/path file_watcher

# Using volume mount
docker run -v /host/music:/data/music file_watcher

# Both environment variable and mount
docker run -e DATA_DIR=/app/music -v /host/music:/app/music file_watcher
```

### Testing Requirements
[Source: architecture/test-strategy-and-standards.md]
- Test configuration in unit tests
- Docker integration tests required
- Document test scenarios
- Ensure all edge cases covered

### Coding Standards
[Source: architecture/coding-standards.md]
- Environment variables for configuration
- Proper error handling and logging
- Clear documentation required
- Follow Docker best practices

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-28 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)
