# Story 5.5: Convert Between CUE Formats

## Story Details
- **Epic**: 5 - Build a Robust CUE File Handler
- **Story Number**: 5.5
- **Status**: Approved
- **Created**: 2025-08-27
- **Dependencies**: Stories 5.1 (Parser), 5.2 (Generator), and 5.4 (Validator) should be completed first

## User Story
**As a** DJ using multiple software platforms
**I want** to convert CUE files between different formats
**So that** I can use them across all my tools

## Acceptance Criteria
1. Convert between standard and CDJ formats
2. Preserve all possible metadata
3. Handle format-specific limitations gracefully
4. Provide conversion reports
5. Batch conversion support

## Tasks / Subtasks

### Task 1: Create CUE Converter Module (AC: 1, 2, 3, 4, 5)
- [ ] Create services/analysis_service/src/cue_handler/converter.py
- [ ] Create services/analysis_service/src/cue_handler/format_mappings.py
- [ ] Create services/analysis_service/src/cue_handler/compatibility.py
- [ ] Add converter exports to services/analysis_service/src/cue_handler/__init__.py

### Task 2: Implement CueConverter Class (AC: 1, 2, 3, 4)
- [ ] Create CueConverter class using parser, generator, and validator
- [ ] Implement convert() method for single file conversion
- [ ] Implement batch_convert() for multiple files
- [ ] Add format auto-detection using parser
- [ ] Track conversion statistics and issues
- [ ] Support dry-run mode for preview

### Task 3: Define Format Specifications (AC: 1, 3)
- [ ] Document standard CUE format requirements
- [ ] Document CDJ format specifics and limitations
- [ ] Document Traktor format requirements
- [ ] Document Serato format specifics
- [ ] Document Rekordbox format requirements
- [ ] Document Kodi media player format
- [ ] Create format capability matrix

### Task 4: Implement Format Mappings (AC: 2, 3)
- [ ] Create command mapping tables between formats
- [ ] Define metadata field mappings
- [ ] Handle format-specific REM fields
- [ ] Map FLAGS between format variants
- [ ] Handle character encoding differences
- [ ] Define lossy conversion rules

### Task 5: Implement Standard to CDJ Conversion (AC: 1, 2, 3)
- [ ] Remove unsupported commands for CDJ
- [ ] Convert REM fields to CDJ-compatible format
- [ ] Adjust INDEX precision if needed
- [ ] Handle multi-file to single-file conversion
- [ ] Validate CDJ track limit (999 tracks max)
- [ ] Generate CDJ-specific metadata

### Task 6: Implement Traktor Format Conversion (AC: 1, 2, 3)
- [ ] Add Traktor-specific REM fields
- [ ] Convert cue points to Traktor format
- [ ] Handle Traktor's grid markers
- [ ] Add BPM information if available
- [ ] Generate Traktor collection tags
- [ ] Handle key detection data

### Task 7: Implement Serato Format Conversion (AC: 1, 2, 3)
- [ ] Convert to Serato cue point format
- [ ] Handle Serato's color coding
- [ ] Add Serato-specific metadata
- [ ] Convert loop points if present
- [ ] Handle Serato's flip/cue features
- [ ] Generate Serato analysis data

### Task 8: Implement Rekordbox Format Conversion (AC: 1, 2, 3)
- [ ] Convert to Rekordbox XML format if needed
- [ ] Handle memory cues and hot cues
- [ ] Add Rekordbox-specific tags
- [ ] Convert beat grid information
- [ ] Handle phrase analysis data
- [ ] Generate Rekordbox collection format

### Task 9: Implement Kodi Format Conversion (AC: 1, 2, 3)
- [ ] Add Kodi-specific REM fields
- [ ] Handle DISCNUMBER for multi-disc
- [ ] Convert to Kodi's encoding preference
- [ ] Add album art references if available
- [ ] Generate Kodi NFO companion files
- [ ] Handle Kodi's replay gain tags

### Task 10: Implement Compatibility Checking (AC: 3, 4)
- [ ] Check source format capabilities
- [ ] Identify lossy conversions
- [ ] Detect incompatible features
- [ ] Generate compatibility warnings
- [ ] Suggest alternative conversions
- [ ] Create fallback strategies

### Task 11: Implement Conversion Reporting (AC: 4)
- [ ] Track all changes made during conversion
- [ ] Log removed/modified commands
- [ ] Report metadata loss or truncation
- [ ] Generate before/after comparison
- [ ] Create conversion summary statistics
- [ ] Support verbose and quiet modes

### Task 12: Implement Batch Processing (AC: 5)
- [ ] Support wildcard file selection
- [ ] Process multiple files in parallel
- [ ] Generate batch conversion report
- [ ] Handle errors gracefully per file
- [ ] Support output directory specification
- [ ] Implement progress tracking

### Task 13: Create Integration Features (AC: 1, 2, 3, 4, 5)
- [ ] Integrate with validator for pre/post checks
- [ ] Create CLI interface for conversions
- [ ] Add conversion preview mode
- [ ] Support custom conversion rules
- [ ] Implement conversion profiles
- [ ] Add rollback capability

### Task 14: Create Unit Tests for Converter
- [ ] Test each format pair conversion
- [ ] Test metadata preservation
- [ ] Test lossy conversion handling
- [ ] Test batch processing
- [ ] Test error recovery
- [ ] Test format auto-detection
- [ ] Validate output with validator from Story 5.4
- [ ] Test round-trip conversions

## Dev Notes

### Dependencies
- **Story 5.1**: Parser for reading source CUE files
- **Story 5.2**: Generator for creating target format
- **Story 5.4**: Validator for checking conversion results
All three stories must be complete before starting this story.

### Relevant Architecture Information

#### Tech Stack
[Source: architecture/tech-stack.md]
- **Language**: Python 3.13
- **Testing**: pytest framework
- **Code Standards**: ruff for linting, mypy for type checking

#### Project Structure
[Source: architecture/source-tree.md]
The CUE converter will complete the analysis_service CUE handler:
- Location: `services/analysis_service/src/cue_handler/converter.py`
- Mappings: `services/analysis_service/src/cue_handler/format_mappings.py`
- Compatibility: `services/analysis_service/src/cue_handler/compatibility.py`
- Tests: `tests/unit/analysis_service/test_cue_handler/test_converter.py`

#### Format Specifications from Epic
[Source: docs/prd/epic-5-cue-file-handler.md#L204-215]

**Format Requirements**:
- Convert between standard and CDJ formats
- Preserve all possible metadata
- Handle format-specific limitations gracefully
- Provide conversion reports
- Batch conversion support

### Format Capability Matrix

| Feature | Standard | CDJ | Traktor | Serato | Rekordbox | Kodi |
|---------|----------|-----|---------|--------|-----------|------|
| Max Tracks | 99 | 999 | Unlimited | Unlimited | Unlimited | 99 |
| Multi-FILE | Yes | No | Yes | No | No | Yes |
| REM Fields | All | Limited | Extended | Custom | Custom | Extended |
| PREGAP/POSTGAP | Yes | No | No | No | No | Yes |
| FLAGS | All | Limited | N/A | N/A | N/A | Limited |
| Character Limit | 80 | 80 | 255 | 255 | 255 | 255 |
| ISRC Support | Yes | Yes | No | No | Yes | Yes |
| BPM Storage | REM | REM | Native | Native | Native | REM |
| Color Coding | No | No | Yes | Yes | Yes | No |
| Loop Points | No | No | Yes | Yes | Yes | No |
| Beat Grid | No | No | Yes | Yes | Yes | No |

### Conversion Rules

#### Standard → CDJ
```python
conversion_rules = {
    "remove_commands": ["PREGAP", "POSTGAP", "SONGWRITER"],
    "limit_tracks": 999,
    "force_single_file": True,
    "simplify_rem": True,
    "preserve": ["TITLE", "PERFORMER", "INDEX", "ISRC"]
}
```

#### Standard → Traktor
```python
conversion_rules = {
    "add_rem_fields": ["BPM", "KEY", "ENERGY"],
    "convert_indices_to_cues": True,
    "add_grid_markers": True,
    "encoding": "UTF-8",
    "max_title_length": 255
}
```

#### Standard → Serato
```python
conversion_rules = {
    "convert_to_serato_format": True,
    "add_color_tags": True,
    "generate_analysis_data": True,
    "convert_cues_to_memory": True,
    "add_flip_data": False
}
```

#### Standard → Rekordbox
```python
conversion_rules = {
    "generate_xml": False,  # Optional XML export
    "add_memory_cues": True,
    "add_hot_cues": True,
    "convert_beat_grid": True,
    "add_phrase_analysis": False,
    "preserve_isrc": True
}
```

#### Standard → Kodi
```python
conversion_rules = {
    "add_discnumber": True,
    "add_replay_gain": True,
    "generate_nfo": True,
    "encoding": "UTF-8",
    "preserve_all_rem": True
}
```

### Lossy Conversion Warnings

```python
LOSSY_CONVERSIONS = {
    ("standard", "cdj"): [
        "PREGAP/POSTGAP commands will be removed",
        "Multi-file references will be consolidated",
        "Extended REM fields may be lost"
    ],
    ("cdj", "standard"): [
        "CDJ-specific optimizations will be lost"
    ],
    ("standard", "traktor"): [
        "ISRC codes not supported in Traktor",
        "FLAGS will be ignored"
    ],
    ("traktor", "standard"): [
        "Beat grid information will be stored as REM",
        "Color coding will be lost",
        "Loop points will be lost"
    ]
}
```

### Conversion Report Structure

```python
@dataclass
class ConversionReport:
    source_file: str
    source_format: str
    target_file: str
    target_format: str
    success: bool
    changes: List[ConversionChange]
    warnings: List[str]
    errors: List[str]
    metadata_preserved: float  # Percentage

@dataclass
class ConversionChange:
    change_type: str  # "removed", "modified", "added"
    command: str
    original_value: Optional[str]
    new_value: Optional[str]
    reason: str
```

### Batch Conversion Example

```python
from cue_handler import CueConverter

# Convert multiple files
converter = CueConverter()
results = converter.batch_convert(
    source_pattern="*.cue",
    target_format="cdj",
    output_dir="cdj_cues/",
    parallel=True,
    validate=True
)

# Generate batch report
for result in results:
    if not result.success:
        print(f"Failed: {result.source_file}")
        for error in result.errors:
            print(f"  - {error}")
    else:
        print(f"Converted: {result.source_file} ({result.metadata_preserved:.1f}% preserved)")
```

### Testing Standards
[Source: architecture/test-strategy-and-standards.md]
- **Framework**: pytest with `uv run pytest` execution
- **Test Files**: `tests/unit/analysis_service/test_cue_handler/test_converter.py`
- **Coverage Goal**: Minimum 80% for new code
- **Round-trip Testing**: Convert A→B→A and verify equivalence
- **Validation**: Use validator from Story 5.4 on all outputs

### Code Standards
[Source: architecture/coding-standards.md]
- **MANDATORY**: Use `uv run python` instead of `python` or `python3`
- **MANDATORY**: Use `uv run pytest` for running tests
- **Pre-commit hooks**: Must pass before committing
- **Type hints**: Required with mypy validation

### CLI Interface Design

```bash
# Single file conversion
uv run python -m cue_handler.converter input.cue --format cdj --output output.cue

# Batch conversion
uv run python -m cue_handler.converter *.cue --format traktor --output-dir converted/

# Preview conversion
uv run python -m cue_handler.converter input.cue --format serato --dry-run

# With validation
uv run python -m cue_handler.converter input.cue --format rekordbox --validate

# Verbose mode
uv run python -m cue_handler.converter input.cue --format kodi --verbose
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-27 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent after implementation*
