# Story 9.4: Create Rename Proposal Engine

## Status
Approved

## Story
**As a** user organizing files
**I want** intelligent rename suggestions
**So that** I can quickly organize my library

## Acceptance Criteria
1. Generate rename proposals based on learned patterns
2. Confidence scoring implemented for each proposal (0-100%)
3. Batch proposal generation working for multiple files
4. Proposal explanation system provides reasoning for suggestions
5. Handle naming conflicts and duplicate detection
6. Cache predictions in Redis for performance
7. Generate proposals in <100ms per file
8. Support custom naming templates from users

## Tasks / Subtasks
- [ ] Design proposal generation system (AC: 1)
  - [ ] Define proposal data structure
  - [ ] Create generation algorithm
  - [ ] Plan template system
  - [ ] Design conflict resolution
- [ ] Implement proposal generator (AC: 1, 8)
  - [ ] Integrate with ML model predictions
  - [ ] Apply learned patterns
  - [ ] Support custom templates
  - [ ] Generate multiple alternatives
- [ ] Build confidence scoring (AC: 2)
  - [ ] Calculate model confidence
  - [ ] Factor in pattern frequency
  - [ ] Consider user feedback history
  - [ ] Normalize scores to 0-100%
- [ ] Create batch processing (AC: 3, 7)
  - [ ] Implement parallel processing
  - [ ] Optimize for large batches
  - [ ] Add progress tracking
  - [ ] Handle partial failures
- [ ] Implement explanation system (AC: 4)
  - [ ] Generate human-readable explanations
  - [ ] Show which patterns matched
  - [ ] Indicate confidence factors
  - [ ] Provide alternative reasoning
- [ ] Handle conflicts (AC: 5)
  - [ ] Detect potential duplicates
  - [ ] Implement collision resolution
  - [ ] Add sequential numbering for duplicates
  - [ ] Validate against existing files
- [ ] Add Redis caching (AC: 6, 7)
  - [ ] Cache recent predictions
  - [ ] Implement cache invalidation
  - [ ] Add TTL for cache entries
  - [ ] Monitor cache hit rates
- [ ] Create proposal API (AC: 1-8)
  - [ ] POST `/rename/propose` - Single file proposal
  - [ ] POST `/rename/propose/batch` - Batch proposals
  - [ ] GET `/rename/templates` - Get templates
  - [ ] POST `/rename/templates` - Save custom template
  - [ ] POST `/rename/validate` - Check for conflicts
- [ ] Write tests (AC: 7)
  - [ ] Test proposal generation
  - [ ] Test conflict detection
  - [ ] Test caching behavior
  - [ ] Performance benchmarks

## Dev Notes

### Previous Story Insights
Depends on Stories 9.2 and 9.3 - requires tokenization and ML model for generating proposals.

### Data Models
Proposal System:
```python
class RenameProposal:
    original_filename: str
    proposed_filename: str
    confidence_score: float
    explanation: str
    patterns_used: List[str]
    alternatives: List[str]
    conflict_status: str  # none, duplicate, similar

class NamingTemplate:
    id: str
    name: str
    pattern: str  # e.g., "{artist} - {date} - {venue} - {quality}"
    user_id: str
    created_at: datetime
    usage_count: int

class ConflictResolution:
    strategy: str  # append_number, skip, replace
    existing_file: str
    proposed_action: str
```

### API Specifications
Proposal endpoints:
- POST `/rename/propose` - Generate single proposal
- POST `/rename/propose/batch` - Batch generation
- GET `/rename/explain/{proposal_id}` - Get explanation
- POST `/rename/apply` - Apply rename
- GET `/rename/conflicts` - Check conflicts

### Component Specifications
Not applicable - backend service only

### File Locations
- Proposal engine: `services/file_rename_service/app/proposal/`
- Proposal generator: `services/file_rename_service/app/proposal/generator.py`
- Confidence scorer: `services/file_rename_service/app/proposal/scorer.py`
- Conflict resolver: `services/file_rename_service/app/proposal/conflicts.py`
- Template manager: `services/file_rename_service/app/proposal/templates.py`
- Tests: `tests/unit/file_rename_service/test_proposal_engine.py`

### Testing Requirements
[Source: architecture/test-strategy-and-standards.md]
- Test proposal generation accuracy
- Test conflict detection and resolution
- Validate caching behavior
- Performance tests for batch operations
- Mock ML model and Redis

### Technical Constraints
[Source: architecture/tech-stack.md]
- Use Redis for caching with 15-minute TTL
- Implement async processing for batch operations
- Use PostgreSQL for template storage
- Ensure thread-safe operations for parallel processing

### Performance Requirements
- Single proposal: <100ms
- Batch of 100 files: <5 seconds
- Cache hit rate: >80% for recent files
- Conflict checking: <50ms per file

## Testing
- Test location: `tests/unit/file_rename_service/test_proposal_engine.py`
- Performance requirement: <100ms per proposal
- Batch processing: 100 files in <5 seconds
- Conflict detection accuracy: 100%
- Cache hit rate target: >80%

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-01-29 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
[To be filled by dev agent]

### Debug Log References
[To be filled by dev agent]

### Completion Notes List
[To be filled by dev agent]

### File List
[To be filled by dev agent]

## QA Results
[To be filled by QA agent]
