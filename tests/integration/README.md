# Integration Tests for BPM Detection

This directory contains comprehensive integration tests for the BPM detection pipeline.

## Overview

The integration tests verify the complete workflow from audio file input to stored BPM data, including:

- **End-to-end pipeline testing**: Audio file â†’ BPM detection â†’ Storage
- **Performance optimization validation**: Memory usage, streaming, parallel processing
- **Caching layer verification**: Redis integration and cache hit/miss scenarios
- **Error handling**: Edge cases, malformed files, network failures
- **Accuracy validation**: Known BPM test files with expected results

## Test Structure

### Core Integration Tests (`test_bpm_integration.py`)

#### BPM Detection Accuracy
- Tests against synthetic audio files with known BPMs
- Validates detection accuracy within tolerance ranges
- Covers multiple BPM ranges: 60, 85, 120, 128, 140, 175 BPM

#### Edge Case Handling
- **Silence**: Silent audio files (should return low confidence)
- **Noise**: White noise (should return low confidence)
- **Short files**: Very short audio clips (<1 second)
- **Variable tempo**: Tracks with changing BPM

#### Pipeline Integration
- **Message Consumer**: Full workflow from RabbitMQ message to storage
- **Caching**: Redis cache hit/miss scenarios
- **Storage**: PostgreSQL and Neo4j data persistence
- **Configuration**: Environment-based configuration management

#### Performance Testing
- **Memory usage**: Memory monitoring during processing
- **Streaming**: Large file streaming for memory efficiency
- **Parallel processing**: Concurrent file processing
- **Batch operations**: Multiple file processing optimization

### Test Fixtures

#### Synthetic Audio Files
Generated by `tests/fixtures/generate_test_audio.py`:

- **Click tracks**: Precise metronome-style clicks at known BPMs
- **Drum patterns**: Basic 4/4 drum patterns with kick, snare, hi-hat
- **Variable tempo**: Gradual tempo changes from 100-140 BPM
- **Edge cases**: Silence, noise, very short files

#### Test Data Structure
```
tests/fixtures/
â”œâ”€â”€ test_60bpm_click.wav     # 60 BPM click track
â”œâ”€â”€ test_60bpm_slow.wav      # 60 BPM drum pattern
â”œâ”€â”€ test_85bpm_hiphop.wav    # 85 BPM hip-hop style
â”œâ”€â”€ test_120bpm_rock.wav     # 120 BPM rock style
â”œâ”€â”€ test_128bpm_electronic.wav # 128 BPM electronic style
â”œâ”€â”€ test_140bpm_dnb.wav      # 140 BPM drum & bass style
â”œâ”€â”€ test_175bpm_fast.wav     # 175 BPM fast pattern
â”œâ”€â”€ test_variable_tempo.wav  # Variable tempo (100-140 BPM)
â”œâ”€â”€ test_silence.wav         # Silent audio
â”œâ”€â”€ test_white_noise.wav     # White noise
â””â”€â”€ test_very_short.wav      # 0.5 second audio
```

## Running Tests

### Quick Test Run
```bash
# Run integration tests only
uv run python -m pytest tests/integration/ -v

# Run with coverage
uv run python -m pytest tests/integration/ --cov=services.analysis_service.src
```

### Comprehensive Test Suite
```bash
# Run the complete test suite with reporting
uv run python tests/run_integration_tests.py
```

### Generate Test Audio
```bash
# Generate synthetic test audio files
uv run python tests/fixtures/generate_test_audio.py
```

## Test Requirements

### Dependencies
```bash
# Core testing
uv add pytest pytest-asyncio

# Coverage reporting
uv add pytest-cov

# Audio processing (for real audio tests)
uv add essentia-tensorflow  # Or essentia

# Performance monitoring
uv add psutil

# Mock and test utilities
uv add pytest-mock
```

### Environment Setup
The tests use the same configuration system as the main application. Set environment variables as needed:

```bash
# Redis configuration
export TRACKTION_CACHE_REDIS_HOST=localhost
export TRACKTION_CACHE_REDIS_PORT=6379

# Database configuration
export TRACKTION_DATABASE_HOST=localhost
export TRACKTION_DATABASE_NAME=tracktion_test

# Performance settings
export TRACKTION_PERFORMANCE_PARALLEL_WORKERS=4
export TRACKTION_PERFORMANCE_MEMORY_LIMIT_MB=1000
```

## Test Categories

### ðŸŽ¯ Accuracy Tests
Verify BPM detection accuracy against known reference files:
- **Tolerance**: Â±5 BPM for most files, Â±10 BPM for very fast tracks
- **Confidence**: Must exceed 0.5 for valid audio, below 0.7 for noise/silence
- **Algorithms**: Test multiple detection algorithms (RhythmExtractor2013, PercivalBpmEstimator)

### âš¡ Performance Tests
Validate performance optimizations and resource usage:
- **Memory**: Stay within configured memory limits
- **Streaming**: Automatically stream large files (>50MB)
- **Parallel**: Process multiple files concurrently
- **Caching**: Redis caching reduces duplicate processing

### ðŸ”§ Integration Tests
End-to-end workflow validation:
- **Message Processing**: RabbitMQ â†’ Analysis â†’ Storage
- **Error Handling**: Graceful failure for invalid files
- **Configuration**: Environment-based configuration loading
- **Database Storage**: PostgreSQL metadata + Neo4j relationships

### ðŸ§ª Edge Case Tests
Robustness testing for unusual inputs:
- **Silent Files**: Detect and handle appropriately
- **Noise**: Random noise should not produce false positives
- **Corrupted Files**: Handle malformed audio gracefully
- **Network Issues**: Redis/database connection failures

## Continuous Integration

### CI/CD Pipeline Integration
The tests are designed to run in CI/CD environments:

```yaml
# Example GitHub Actions workflow
- name: Generate Test Audio
  run: uv run python tests/fixtures/generate_test_audio.py

- name: Run Integration Tests
  run: uv run python -m pytest tests/integration/ --junitxml=results.xml

- name: Upload Coverage
  run: uv run python -m pytest tests/ --cov=services.analysis_service.src --cov-report=xml
```

### Performance Benchmarks
Set performance baselines in CI:
- **Processing Speed**: <2 seconds per 30-second audio file
- **Memory Usage**: <100MB per concurrent worker
- **Accuracy**: >90% accuracy within Â±5 BPM tolerance
- **Cache Hit Rate**: >80% for repeated files

## Troubleshooting

### Common Issues

#### Missing Test Audio Files
```bash
# Generate synthetic test files
uv run python tests/fixtures/generate_test_audio.py
```

#### Essentia Import Errors
```bash
# Install Essentia for audio processing
uv add essentia-tensorflow

# Or use the fallback mode (tests will use mock audio)
export TRACKTION_TEST_USE_MOCK_AUDIO=true
```

#### Redis Connection Errors
```bash
# Use in-memory cache for testing
export TRACKTION_CACHE_TYPE=memory

# Or start Redis
docker run -d -p 6379:6379 redis:alpine
```

#### Performance Test Failures
```bash
# Adjust performance limits for test environment
export TRACKTION_PERFORMANCE_MEMORY_LIMIT_MB=2000
export TRACKTION_PERFORMANCE_PARALLEL_WORKERS=2
```

### Debug Mode
Enable verbose logging for debugging:
```bash
export TRACKTION_LOG_LEVEL=DEBUG
uv run python -m pytest tests/integration/ -v -s
```

## Contributing

### Adding New Tests
1. **Audio Tests**: Add new synthetic audio generators to `generate_test_audio.py`
2. **Pipeline Tests**: Add workflow tests to `test_bpm_integration.py`
3. **Performance Tests**: Add benchmarks with specific performance criteria
4. **Edge Cases**: Add robustness tests for new failure modes

### Test Data Guidelines
- **Synthetic Audio**: Use generated audio to avoid copyright issues
- **Known BPMs**: Document expected BPM values and tolerance ranges
- **File Formats**: Test multiple audio formats (WAV, MP3, FLAC, M4A)
- **Duration**: Include files of varying lengths (0.5s to 10+ minutes)

### Performance Criteria
- **Accuracy**: >90% within Â±5 BPM for clean audio
- **Speed**: <2 seconds processing per 30-second file
- **Memory**: <100MB per worker process
- **Reliability**: <1% failure rate for valid audio files
